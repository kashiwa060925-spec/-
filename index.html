<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<!-- â˜… ã‚¹ãƒãƒ›å‘ã‘ï¼šã‚ºãƒ¼ãƒ æŠ‘åˆ¶ï¼†ã‚¿ãƒƒãƒ—å¿«é©åŒ– -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPGï¼ˆHTMLä¸€æšï¼ã‚¿ãƒƒãƒ—å°‚ç”¨ï¼‰</title>
<style>
  :root{
    --c-bg:#0f1220;
    --c-panel:#171a2b;
    --c-accent:#7cd2ff;
    --c-accent2:#9eff7c;
    --c-text:#e8eefc;
    --c-sub:#aab6d6;
    --c-danger:#ff6b6b;
    --c-gold:#ffd76a;
    --c-rare:#58c7ff;
    --c-epic:#c58cff;
    --c-legend:#ffb36a;
    --c-hp:#35d07f;
  }
  *{box-sizing:border-box}
  html, body {
    height:100%;
    -webkit-text-size-adjust: 100%;
  }
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:linear-gradient(180deg,#0d1120,#0b1021 50%,#0e0f1a);
    color:var(--c-text);
    /* â˜… ã‚¿ãƒƒãƒ—ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™ï¼ˆiOS/Androidï¼‰ */
    -webkit-tap-highlight-color: transparent;
  }
  header{
    position:sticky; top:0; z-index:3;
    background:#0d1120cc; backdrop-filter: blur(6px);
    border-bottom:1px solid #1f2440; padding:.6rem .8rem;
  }
  .topbar{display:flex; gap:.8rem; flex-wrap:wrap; align-items:center; justify-content:space-between}
  .wrap{display:flex; gap:.8rem; align-items:center; flex-wrap:wrap}
  .pill{
    background:var(--c-panel); border:1px solid #232742; border-radius:12px;
    padding:.5rem .7rem; font-size:.95rem; color:var(--c-sub)
  }
  .hp-ui{display:flex; align-items:center; gap:.4rem}
  .bar{width:180px; height:12px; border-radius:8px; background:#101425; border:1px solid #283055; overflow:hidden}
  .bar>span{display:block; height:100%; background:linear-gradient(90deg,#2ddf7f,#67e3a3); width:100%}
  .small{font-size:.9rem; color:var(--c-sub)}
  main{max-width:1200px; margin:0 auto; padding:1rem}
  .layout{display:grid; grid-template-columns:1.2fr .9fr; gap:1rem}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}

  .panel{
    background:var(--c-panel); border:1px solid #222647; border-radius:14px; padding:1rem;
    box-shadow:0 8px 24px #00000045, inset 0 1px #2b3159;
  }
  .monster{
    display:grid; grid-template-rows:auto auto auto; gap:.6rem; justify-items:center; text-align:center;
    padding:1rem; border-radius:12px; background:radial-gradient(80% 80% at 50% 30%, #141937, #101635);
    border:1px solid #202554; cursor:pointer; user-select:none;
    /* â˜… ã‚¹ãƒãƒ›ã®300msé…å»¶ã‚’é˜²æ­¢ */
    touch-action: manipulation;
  }
  /* â˜… ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è£…é£¾ã¯ç„¡åŠ¹ï¼ˆã‚¿ãƒƒãƒ—å°‚ç”¨ã®ãŸã‚ï¼‰ */
  .monster:focus{outline: none; box-shadow:none}
  .monster-emoji{font-size:76px; line-height:1}
  .hpbar{width:100%; height:18px; background:#0c1026; border:1px solid #2a2f5a; border-radius:10px; overflow:hidden}
  .hpbar>div{height:100%; background:linear-gradient(90deg,#ff6b6b,#ff9f6b); width:100%; transition:width .12s ease}
  .monster-info{display:flex; justify-content:space-between; width:100%; color:var(--c-sub); font-weight:600}
  .actions{display:flex; gap:.8rem; flex-wrap:wrap; justify-content:center}
  .btn{
    background:#0f1536; color:#cfe0ff; border:1px solid #2a2f66; padding:.8rem 1.1rem; border-radius:12px; cursor:pointer;
    /* â˜… ã‚¿ãƒƒãƒ—æœ€é©åŒ– */
    touch-action: manipulation;
    min-width: 44px; min-height: 44px;
  }
  .btn:hover{background:#121a43}
  .btn.gold{border-color:#6e5a25; background:#221b08; color:#ffd76a}
  .btn.danger{border-color:#6b2833; background:#2a0d14; color:#ffb0b0}
  .grid{display:grid; gap:.6rem}
  .tabs{display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.6rem}
  .tab{background:#121639; border:1px solid #2a2f66; padding:.7rem 1rem; border-radius:12px; cursor:pointer; color:#c9d6ff; touch-action: manipulation;}
  .tab.active{background:#1a2053; outline:2px solid #6888ff66}
  .inv-list{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:.6rem}
  .card{
    background:#0f1433; border:1px solid #2a2f66; border-radius:10px; padding:.7rem; display:grid; gap:.35rem
  }
  .rar-Common{color:#e0e6ff}
  .rar-Uncommon{color:#9eff7c}
  .rar-Rare{color:#58c7ff}
  .rar-Epic{color:#c58cff}
  .rar-Legendary{color:#ffb36a}
  .row{display:flex; justify-content:space-between; gap:.6rem; align-items:center; flex-wrap:wrap}
  .muted{color:var(--c-sub)}
  .warn{color:var(--c-danger)}
  .gold{color:var(--c-gold)}
  .footnote{margin-top:.8rem; color:#98a2c9; font-size:.9rem}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="wrap">
      <div class="pill">éšå±¤ <b id="floor">1</b> <span id="bossTimer" class="small"></span></div>
      <div class="pill">æ‰€æŒ <span class="gold"><b id="gold">0</b> G</span></div>
      <div class="pill">Lv <b id="level">1</b> / EXP <b id="exp">0</b></div>
      <div class="pill">
        HP
        <span class="bar" aria-label="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP"><span id="hpbar" style="width:100%"></span></span>
        <span class="small" id="hptext">10/10</span>
      </div>
      <div class="pill">ATK <b id="atk">1</b> / ã‚¯ãƒªç‡ <b id="crit">5%</b></div>
      <div class="pill">ã‚½ã‚¦ãƒ« <b id="souls">0</b></div>
    </div>
    <!-- â˜… ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ¡ˆå†…ã¯å‰Šé™¤ -->
  </div>
</header>

<main>
  <div class="layout">
    <!-- å·¦ï¼šæˆ¦é—˜ -->
    <section class="panel">
      <!-- â˜… tabindexã‚„roleã¯å¤–ã—ã€å®Œå…¨ã‚¿ãƒƒãƒ—å°‚ç”¨ã« -->
      <div id="monster" class="monster" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ”»æ’ƒ">
        <div class="monster-emoji" id="monsterFace" aria-hidden="true">ğŸ‘¹</div>
        <div class="hpbar" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼HP"><div id="monsterHP" style="width:100%"></div></div>
        <div class="monster-info">
          <span id="monsterName">Lv1 ã‚´ãƒ–ãƒªãƒ³</span>
          <span id="monsterHPText">10 / 10</span>
        </div>
        <div class="actions">
          <button class="btn" id="attackBtn">æ”»æ’ƒï¼ˆã‚¿ãƒƒãƒ—ï¼‰</button>
          <button class="btn gold" id="nextBtn" title="å€’ã—ãŸã‚‰è‡ªå‹•ã§æ¬¡ã¸é€²ã¿ã¾ã™">æ¬¡ã®éšå±¤ã¸</button>
          <button class="btn danger" id="fleeBtn">1éšæˆ»ã‚‹</button>
        </div>
        <div class="small" id="logline" aria-live="polite"></div>
      </div>
      <div class="footnote">10éšã”ã¨ã«ãƒœã‚¹ï¼ˆ<span class="warn">åˆ¶é™æ™‚é–“30ç§’</span>ï¼‰ã€‚æ­»äº¡ã™ã‚‹ã¨5ç§’ã§è‡ªå‹•å¾©æ´»ã€‚ã‚¿ãƒƒãƒ—ã®ã¿ã§éŠã¹ã¾ã™ã€‚</div>
    </section>

    <!-- å³ï¼šã‚¿ãƒ– -->
    <section class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="tab-upg">å¼·åŒ–</button>
        <button class="tab" data-tab="tab-inv">è£…å‚™</button>
        <button class="tab" data-tab="tab-sta">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
        <button class="tab" data-tab="tab-sys">è¨­å®š/è»¢ç”Ÿ</button>
      </div>

      <div id="tab-upg" class="grid">
        <div class="card">
          <div class="row">
            <div><b>æ”»æ’ƒåŠ›å¼·åŒ–</b><div class="small muted">ã‚¯ãƒªãƒƒã‚¯ä¸ãƒ€ãƒ¡ã‚’å¢—åŠ </div></div>
            <div class="gold"><b id="costAtk">10</b> G</div>
          </div>
          <button class="btn" id="buyAtk">è³¼å…¥ (+1 ATK)</button>
        </div>
        <div class="card">
          <div class="row">
            <div><b>æœ€å¤§HPå¼·åŒ–</b><div class="small muted">è€ä¹…ã‚’å¢—åŠ </div></div>
            <div class="gold"><b id="costHP">10</b> G</div>
          </div>
          <button class="btn" id="buyHP">è³¼å…¥ (+5 HP)</button>
        </div>
        <div class="card">
          <div class="row">
            <div><b>è‡ªå‹•ã‚¿ãƒƒãƒ—</b><div class="small muted">æ¯ç§’è‡ªå‹•æ”»æ’ƒï¼ˆATKã«ä¾å­˜ï¼‰</div></div>
            <div class="gold"><b id="costAuto">25</b> G</div>
          </div>
          <button class="btn" id="buyAuto">è³¼å…¥ (+0.2 ã‚¿ãƒƒãƒ—/ç§’)</button>
          <div class="small muted">ç¾åœ¨ï¼š<b id="autoRate">0.0</b> ã‚¿ãƒƒãƒ—/ç§’</div>
        </div>
      </div>

      <div id="tab-inv" class="grid" hidden>
        <div class="card">
          <div><b>è£…å‚™ä¸­</b></div>
          <div class="small">æ­¦å™¨ï¼š<span id="eq-weapon">ãªã—</span></div>
          <div class="small">é§ã€€ï¼š<span id="eq-armor">ãªã—</span></div>
          <div class="small">æŒ‡è¼ªï¼š<span id="eq-ring">ãªã—</span></div>
        </div>
        <div class="card">
          <div class="row">
            <b>æ‰€æŒå“</b>
            <label class="small"><input type="checkbox" id="autoEquip" /> å¼·ã„è£…å‚™ã‚’è‡ªå‹•è£…å‚™</label>
          </div>
          <div class="inv-list" id="invList"></div>
        </div>
      </div>

      <div id="tab-sta" class="grid" hidden>
        <div class="card">
          <b>åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</b>
          <div class="small">ATKï¼š<b id="sta-atk">1</b></div>
          <div class="small">æœ€å¤§HPï¼š<b id="sta-hp">10</b></div>
          <div class="small">é˜²å¾¡ï¼š<b id="sta-def">0</b></div>
          <div class="small">ã‚¯ãƒªç‡ï¼š<b id="sta-crit">5%</b></div>
          <div class="small">ã‚´ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒŠã‚¹ï¼š<b id="sta-goldb">0%</b></div>
          <div class="small">ã‚½ã‚¦ãƒ«è£œæ­£ï¼ˆæ’ä¹…ï¼‰ï¼š<b id="sta-soulb">0%</b></div>
        </div>
        <div class="card">
          <b>æˆ¦ç¸¾</b>
          <div class="small">æœ€é«˜åˆ°é”éšå±¤ï¼š<b id="sta-maxfloor">1</b></div>
          <div class="small">è¨ä¼æ•°ï¼š<b id="sta-kills">0</b></div>
          <div class="small">æ­»äº¡æ•°ï¼š<b id="sta-deaths">0</b></div>
        </div>
      </div>

      <div id="tab-sys" class="grid" hidden>
        <div class="card">
          <b>ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰</b>
          <div class="row">
            <button class="btn" id="saveBtn">ä¿å­˜</button>
            <button class="btn" id="loadBtn">èª­è¾¼</button>
            <button class="btn" id="exportBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button class="btn" id="importBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <button class="btn danger" id="wipeBtn">å…¨å‰Šé™¤</button>
          </div>
          <textarea id="ioArea" rows="4" style="width:100%; background:#0b0f25; color:#cfe0ff; border:1px solid #2a2f66; border-radius:8px; margin-top:.5rem" placeholder="ã“ã“ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚Šã¾ã™ï¼ˆæ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰"></textarea>
        </div>
        <div class="card">
          <b>è»¢ç”Ÿï¼ˆãƒ‘ãƒ¼ãƒãƒãƒ³ãƒˆå¼·åŒ–ï¼‰</b>
          <div class="small">è»¢ç”Ÿã™ã‚‹ã¨éšå±¤/è£…å‚™/æ‰€æŒé‡‘ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ãŒã€<b>ã‚½ã‚¦ãƒ«</b>ã‚’ç²å¾—ã—ã€ä¸ãƒ€ãƒ¡ï¼†ç²å¾—Goldã«æ’ä¹…ãƒœãƒ¼ãƒŠã‚¹ï¼ˆã‚½ã‚¦ãƒ«1ã¤ã‚ãŸã‚Š +2%ï¼‰</div>
          <div class="row">
            <div>ç²å¾—è¦‹è¾¼ã¿ï¼š<b id="soulGain">0</b> ã‚½ã‚¦ãƒ«</div>
            <button class="btn danger" id="ascendBtn">è»¢ç”Ÿã™ã‚‹</button>
          </div>
        </div>
      </div>

    </section>
  </div>
</main>

<script>
/* ===============================
   ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPGï¼ˆHTMLä¸€æšï¼ã‚¿ãƒƒãƒ—å°‚ç”¨ï¼‰
   =============================== */

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

const RARITIES = [
  {name:'Common',    color:'rar-Common',    weight:60, mult:1.00},
  {name:'Uncommon',  color:'rar-Uncommon',  weight:25, mult:1.40},
  {name:'Rare',      color:'rar-Rare',      weight:10, mult:2.00},
  {name:'Epic',      color:'rar-Epic',      weight:4,  mult:3.00},
  {name:'Legendary', color:'rar-Legendary', weight:1,  mult:4.50},
];
const MONSTER_POOL = [
  {name:'ã‚´ãƒ–ãƒªãƒ³', emoji:'ğŸ‘¹'},
  {name:'ã‚¹ã‚±ãƒ«ãƒˆãƒ³', emoji:'ğŸ’€'},
  {name:'ã‚³ã‚¦ãƒ¢ãƒª', emoji:'ğŸ¦‡'},
  {name:'ã‚ªã‚ªã‚«ãƒŸ', emoji:'ğŸº'},
  {name:'ã‚¹ãƒ©ã‚¤ãƒ ', emoji:'ğŸ«§'},
  {name:'ãƒŸã‚¤ãƒ©', emoji:'ğŸ§»'},
  {name:'é­”å°æ›¸', emoji:'ğŸ“•'},
  {name:'ç›®ç‰', emoji:'ğŸ‘ï¸'},
  {name:'ã‚µã‚½ãƒª', emoji:'ğŸ¦‚'},
];
const BOSS_POOL = [
  {name:'ã‚ªãƒ¼ã‚¬', emoji:'ğŸ‘º'},
  {name:'ãƒ‰ãƒ©ã‚´ãƒ³', emoji:'ğŸ²'},
  {name:'ãƒªãƒƒãƒ', emoji:'ğŸª¦'},
  {name:'ã‚±ãƒ«ãƒ™ãƒ­ã‚¹', emoji:'ğŸ¶'},
];

const SAVE_KEY = 'tap_hns_save_v1';

const state = {
  gold: 0,
  level: 1,
  exp: 0,
  expToNext: 20,
  floor: 1,
  maxFloor: 1,
  kills: 0,
  deaths: 0,
  baseATK: 1,
  baseHP: 10,
  baseDEF: 0,
  baseCRIT: 5, // %
  autoTap: 0, // taps/sec
  eq: {weapon:null, armor:null, ring:null},
  inv: [],
  autoEquip: false,
  monster: null,
  playerHP: 10,
  bossEndsAt: 0,
  souls: 0,
  bestMaxFloor: 1,
};
const prices = { atk: 10, hp: 10, auto: 25 };

const ui = {
  floor: $('#floor'), gold: $('#gold'), level: $('#level'), exp: $('#exp'),
  hpbar: $('#hpbar'), hptext: $('#hptext'),
  atk: $('#atk'), crit: $('#crit'), souls: $('#souls'),
  monsterFace: $('#monsterFace'), monsterHP: $('#monsterHP'),
  monsterHPText: $('#monsterHPText'), monsterName: $('#monsterName'),
  bossTimer: $('#bossTimer'), logline: $('#logline'),
  nextBtn: $('#nextBtn'), fleeBtn: $('#fleeBtn'), attackBtn: $('#attackBtn'),
  tabs: $$('.tab'),
  tabUpg: $('#tab-upg'), tabInv: $('#tab-inv'), tabSta: $('#tab-sta'), tabSys: $('#tab-sys'),
  costAtk: $('#costAtk'), costHP: $('#costHP'), costAuto: $('#costAuto'),
  buyAtk: $('#buyAtk'), buyHP: $('#buyHP'), buyAuto: $('#buyAuto'), autoRate: $('#autoRate'),
  invList: $('#invList'), eqWeapon: $('#eq-weapon'), eqArmor: $('#eq-armor'), eqRing: $('#eq-ring'),
  autoEquip: $('#autoEquip'),
  staAtk: $('#sta-atk'), staHP: $('#sta-hp'), staDef: $('#sta-def'), staCrit: $('#sta-crit'),
  staGoldB: $('#sta-goldb'), staSoulB: $('#sta-soulb'),
  staMaxFloor: $('#sta-maxfloor'), staKills: $('#sta-kills'), staDeaths: $('#sta-deaths'),
  saveBtn: $('#saveBtn'), loadBtn: $('#loadBtn'), exportBtn: $('#exportBtn'), importBtn: $('#importBtn'), wipeBtn: $('#wipeBtn'), ioArea: $('#ioArea'),
  soulGain: $('#soulGain'), ascendBtn: $('#ascendBtn'),
};

function clamp(n, a, b){return Math.max(a, Math.min(b, n));}
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function choice(arr){return arr[randInt(0, arr.length-1)];}
function weightedPick(items){
  const total = items.reduce((s,i)=>s+i.weight,0);
  let r = Math.random()*total;
  for(const it of items){ r -= it.weight; if(r<=0) return it; }
  return items[items.length-1];
}
function soulDamageGoldMultiplier(){ return 1 + state.souls * 0.02; }

function recalcPlayerMaxHP(){
  const armorHP = state.eq.armor?.hp ?? 0;
  const total = state.baseHP + armorHP;
  return Math.max(1,total);
}
function playerATK(){
  const wATK = state.eq.weapon?.atk ?? 0;
  const ringATK = state.eq.ring?.atk ?? 0;
  const total = (state.baseATK + wATK + ringATK) * soulDamageGoldMultiplier();
  return Math.max(1, Math.floor(total));
}
function playerDEF(){ return state.baseDEF + (state.eq.armor?.def ?? 0); }
function playerCRIT(){ return clamp(state.baseCRIT + (state.eq.ring?.crit ?? 0), 0, 100); }
function goldBonusPercent(){
  const ringGold = state.eq.ring?.goldB ?? 0;
  const total = ringGold + (soulDamageGoldMultiplier()-1)*100;
  return total;
}
function clickDamage(){
  const isCrit = Math.random()*100 < playerCRIT();
  let dmg = playerATK();
  if(isCrit) dmg = Math.floor(dmg * 1.8);
  return { dmg, isCrit };
}

function enemyScaleHP(floor, isBoss){
  const base = 14 * Math.pow(floor, 1.18) + 6;
  return Math.floor(base * (isBoss? 6.0 : 1.0));
}
function enemyScaleGold(floor, isBoss){
  const base = 4 * Math.pow(floor, 1.10) + 2;
  return Math.floor(base * (isBoss? 4.0 : 1.0));
}
function enemyScaleATK(floor, isBoss){
  const base = 1.2 * Math.pow(floor, 1.05) + 0.6;
  return Math.floor(base * (isBoss? 2.0 : 1.0));
}

function makeItem(floor){
  const kinds = ['weapon','armor','ring'];
  const kind = choice(kinds);
  const rar = weightedPick(RARITIES);
  const mult = rar.mult;

  const basePow = Math.max(1, Math.floor( (Math.pow(floor, 1.12) + randInt(0, floor)) * 0.5 * mult ));
  const item = {
    id: cryptoRandomId(),
    name: '',
    slot: kind,
    rarity: rar.name,
    color: rar.color,
    lvl: floor,
    value: Math.max(1, Math.floor(basePow * 1.2)),
  };
  if(kind==='weapon'){
    item.atk = Math.max(1, Math.floor(basePow));
    if(rar.name !== 'Common' && Math.random()<0.35) item.crit = 2 + Math.floor(mult*2);
    item.name = `æ­¦å™¨ +${item.atk}`;
  }else if(kind==='armor'){
    item.hp = 4 * Math.max(1, Math.floor(basePow*0.9));
    if(rar.name !== 'Common' && Math.random()<0.3) item.def = Math.floor(mult*1.2);
    item.name = `é§ +${item.hp}HP`;
  }else{
    const roll = Math.random();
    if(roll<0.45) { item.crit = 3 + Math.floor(mult*2); item.name = `æŒ‡è¼ª ã‚¯ãƒª+${item.crit}%`; }
    else if(roll<0.9) { item.atk = Math.max(1, Math.floor(basePow*0.6)); item.name = `æŒ‡è¼ª ATK+${item.atk}`; }
    else { item.goldB = 5 + Math.floor(mult*4); item.name = `æŒ‡è¼ª Gold+${item.goldB}%`; }
  }
  item.name += ` (${rar.name})`;
  return item;
}
function cryptoRandomId(){
  const a = new Uint32Array(2);
  (window.crypto||window.msCrypto).getRandomValues?.(a);
  return [...a].map(x=>x.toString(16)).join('');
}

function spawnMonster(){
  const floor = state.floor;
  const isBoss = (floor % 10 === 0);
  const pool = isBoss ? BOSS_POOL : MONSTER_POOL;
  const pick = choice(pool);
  const hp = enemyScaleHP(floor, isBoss);
  const gold = enemyScaleGold(floor, isBoss);
  const atk = enemyScaleATK(floor, isBoss);

  state.monster = { name: (isBoss? 'ã€BOSSã€‘':'')+`Lv${floor} ${pick.name}`, emoji: pick.emoji, hp, maxHP: hp, gold, atk, isBoss };
  ui.monsterFace.textContent = pick.emoji;
  ui.monsterName.textContent = state.monster.name;
  ui.monsterHPText.textContent = `${state.monster.hp} / ${state.monster.maxHP}`;
  ui.monsterHP.style.width = '100%';
  ui.logline.textContent = isBoss ? 'ãƒœã‚¹å‡ºç¾ï¼30ç§’ä»¥å†…ã«å€’ã›ï¼' : 'ã‚¿ãƒƒãƒ—ã§æ”»æ’ƒï¼';

  if(isBoss){
    state.bossEndsAt = Date.now() + 30_000;
  }else{
    state.bossEndsAt = 0;
  }
}

function awardKill(){
  const m = state.monster;
  const goldB = 1 + goldBonusPercent()/100;
  const gain = Math.floor(m.gold * goldB);
  state.gold += gain;
  state.kills += 1;
  state.exp += Math.max(1, Math.floor(3 + state.floor*0.6));
  while(state.exp >= state.expToNext){
    state.exp -= state.expToNext;
    state.level += 1;
    state.expToNext = Math.floor(state.expToNext * 1.25 + 8);
    state.baseATK += 1;
    state.baseHP += 2;
    ui.logline.textContent = `ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ATK+1 / HP+2`;
  }
  const luck = (state.eq.ring?.goldB ?? 0) * 0.2;
  const dropChance = 0.20 + luck/100;
  if(Math.random() < dropChance){
    const it = makeItem(state.floor);
    state.inv.push(it);
    if(state.autoEquip) tryAutoEquip(it);
    toast(`ãƒ‰ãƒ­ãƒƒãƒ—ï¼š${renderItemText(it)}`);
  }else{
    toast(`+${gain}G`);
  }
  if(state.floor > state.maxFloor) state.maxFloor = state.floor;
  if(state.maxFloor > state.bestMaxFloor) state.bestMaxFloor = state.maxFloor;
}

function renderItemText(it){
  const parts = [];
  if(it.atk) parts.push(`ATK+${it.atk}`);
  if(it.hp) parts.push(`HP+${it.hp}`);
  if(it.def) parts.push(`é˜²å¾¡+${it.def}`);
  if(it.crit) parts.push(`ã‚¯ãƒª+${it.crit}%`);
  if(it.goldB) parts.push(`Gold+${it.goldB}%`);
  return `${it.name} [${parts.join(', ')}]`;
}

function tryAutoEquip(newItem){
  const slot = newItem.slot;
  const cur = state.eq[slot];
  if(betterThan(newItem, cur)){
    state.eq[slot] = newItem;
    toast(`è‡ªå‹•è£…å‚™ï¼š${renderItemText(newItem)}`);
  }
}
function scoreItem(it){
  if(!it) return -1e9;
  let s = 0;
  s += (it.atk??0)*3 + (it.hp??0)*0.4 + (it.def??0)*2 + (it.crit??0)*1.5 + (it.goldB??0)*0.8;
  s += (it.lvl??0)*0.2;
  const rar = RARITIES.find(r=>r.name===it.rarity);
  s *= rar?.mult ?? 1;
  return s;
}
function betterThan(a,b){ return scoreItem(a) > scoreItem(b); }

function attack(){
  if(!state.monster) return;
  if(state.playerHP<=0){ toast('æ°—çµ¶ä¸­â€¦'); return; }
  const m = state.monster;
  if(m.hp<=0) return;

  const {dmg, isCrit} = clickDamage();
  const dealt = Math.min(m.hp, dmg);
  m.hp -= dealt;
  ui.monsterHP.style.width = `${(m.hp/m.maxHP)*100}%`;
  ui.monsterHPText.textContent = `${m.hp} / ${m.maxHP}`;
  ui.logline.textContent = isCrit ? `ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼ -${dealt}` : `-${dealt}`;

  if(m.hp<=0){
    awardKill();
    state.floor += 1;
    if(state.floor%10===0) toast('ãƒœã‚¹ãƒ•ãƒ­ã‚¢ã«åˆ°é”ï¼');
    spawnMonster();
  }
}

function enemyTick(dt){
  if(!state.monster) return;
  const m = state.monster;
  if(m.hp<=0) return;
  const dps = Math.max(0, m.atk - playerDEF()*0.6);
  const dmg = dps * dt;
  if(dmg<=0) return;
  state.playerHP -= dmg;
  if(state.playerHP<=0){
    state.playerHP = 0;
    state.deaths += 1;
    ui.logline.textContent = 'æ°—çµ¶ã—ã¾ã—ãŸâ€¦5ç§’å¾Œã«å¾©æ´»';
    if(!enemyTick._reviving){
      enemyTick._reviving = true;
      setTimeout(()=>{
        state.playerHP = recalcPlayerMaxHP();
        enemyTick._reviving = false;
        ui.logline.textContent = 'å¾©æ´»ï¼';
      }, 5000);
    }
  }
}
function regenTick(dt){
  if(state.playerHP>0){
    const maxhp = recalcPlayerMaxHP();
    state.playerHP = clamp(state.playerHP + dt * (0.8 + state.level*0.02), 0, maxhp);
  }
}
function autoTapTick(dt){
  if(state.autoTap<=0) return;
  autoTapTick._acc = (autoTapTick._acc||0) + state.autoTap * dt;
  while(autoTapTick._acc >= 1){
    autoTapTick._acc -= 1;
    attack();
  }
}
function bossTimerTick(){
  if(state.bossEndsAt>0){
    const left = Math.max(0, state.bossEndsAt - Date.now());
    if(left<=0){
      state.bossEndsAt = 0;
      toast('ãƒœã‚¹è¨ä¼å¤±æ•—â€¦1éšæˆ»ã‚‹');
      state.floor = Math.max(1, state.floor-1);
      spawnMonster();
    }
    ui.bossTimer.textContent = `ï¼ˆãƒœã‚¹æ®‹ã‚Š ${Math.ceil(left/1000)}sï¼‰`;
  }else{
    ui.bossTimer.textContent = '';
  }
}
function toast(msg){ ui.logline.textContent = msg; }

function updateUI(){
  ui.floor.textContent = state.floor;
  ui.gold.textContent = Math.floor(state.gold);
  ui.level.textContent = state.level;
  ui.exp.textContent = `${state.exp}/${state.expToNext}`;
  ui.atk.textContent = playerATK();
  ui.crit.textContent = `${Math.floor(playerCRIT())}%`;
  ui.souls.textContent = state.souls;

  const maxhp = recalcPlayerMaxHP();
  const hpPct = clamp(state.playerHP/maxhp*100, 0, 100);
  ui.hpbar.style.width = `${hpPct}%`;
  ui.hptext.textContent = `${Math.floor(state.playerHP)}/${maxhp}`;

  ui.costAtk.textContent = prices.atk;
  ui.costHP.textContent = prices.hp;
  ui.costAuto.textContent = prices.auto;
  ui.autoRate.textContent = state.autoTap.toFixed(1);

  ui.staAtk.textContent = playerATK();
  ui.staHP.textContent = recalcPlayerMaxHP();
  ui.staDef.textContent = playerDEF();
  ui.staCrit.textContent = `${Math.floor(playerCRIT())}%`;
  ui.staGoldB.textContent = `${Math.floor(goldBonusPercent())}%`;
  ui.staSoulB.textContent = `${Math.floor((soulDamageGoldMultiplier()-1)*100)}%`;
  ui.staMaxFloor.textContent = state.maxFloor;
  ui.staKills.textContent = state.kills;
  ui.staDeaths.textContent = state.deaths;

  ui.eqWeapon.textContent = state.eq.weapon ? renderItemText(state.eq.weapon) : 'ãªã—';
  ui.eqArmor.textContent  = state.eq.armor  ? renderItemText(state.eq.armor)  : 'ãªã—';
  ui.eqRing.textContent   = state.eq.ring   ? renderItemText(state.eq.ring)   : 'ãªã—';

  const gain = Math.floor(state.maxFloor / 30);
  ui.soulGain.textContent = gain;
}

function renderInventory(){
  const box = ui.invList;
  box.innerHTML = '';
  for(const it of state.inv){
    const div = document.createElement('div');
    div.className = 'card';
    const title = document.createElement('div');
    title.innerHTML = `<b class="${it.color}">${it.name}</b>`;
    const stats = document.createElement('div');
    stats.className = 'small';
    stats.textContent = renderItemText(it);
    const row = document.createElement('div');
    row.className = 'row';
    const equipBtn = document.createElement('button');
    equipBtn.className = 'btn';
    equipBtn.textContent = 'è£…å‚™';
    equipBtn.onclick = ()=>{
      state.eq[it.slot] = it;
      toast(`è£…å‚™ï¼š${renderItemText(it)}`);
      updateUI();
    };
    const sellBtn = document.createElement('button');
    sellBtn.className = 'btn gold';
    sellBtn.textContent = `å£²å´ (+${Math.floor(it.value)}G)`;
    sellBtn.onclick = ()=>{
      state.gold += Math.floor(it.value);
      state.inv = state.inv.filter(x=>x!==it);
      renderInventory();
      updateUI();
    };
    row.appendChild(equipBtn); row.appendChild(sellBtn);

    div.appendChild(title);
    div.appendChild(stats);
    div.appendChild(row);
    box.appendChild(div);
  }
}

function buy(costKey, onBuy){
  const cost = prices[costKey];
  if(state.gold < cost){ toast('ãŠé‡‘ãŒè¶³ã‚Šãªã„â€¦'); return; }
  state.gold -= cost;
  onBuy();
  prices[costKey] = Math.floor(prices[costKey] * 1.35 + 2);
  updateUI();
}

function save(manual=false){
  const data = JSON.stringify({
    state:{ ...state, bossEndsAt: 0 },
    prices
  });
  localStorage.setItem(SAVE_KEY, data);
  if(manual) toast('ä¿å­˜ã—ã¾ã—ãŸ');
  ui.ioArea.value = data;
}
function load(manual=false){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw){ if(manual) toast('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  try{
    const obj = JSON.parse(raw);
    Object.assign(state, obj.state);
    Object.assign(prices, obj.prices||{});
    state.playerHP = clamp(state.playerHP, 0, recalcPlayerMaxHP());
    ui.autoEquip.checked = !!state.autoEquip;
    spawnMonster();
    renderInventory();
    updateUI();
    if(manual) toast('èª­è¾¼ã—ã¾ã—ãŸ');
  }catch(e){
    console.error(e);
    toast('èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}
function exportSave(){
  save(false);
  const raw = localStorage.getItem(SAVE_KEY);
  ui.ioArea.value = raw||'';
  toast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ¬„ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');
}
function importSave(){
  const raw = ui.ioArea.value.trim();
  if(!raw){ toast('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™'); return; }
  try{
    JSON.parse(raw);
    localStorage.setItem(SAVE_KEY, raw);
    load(false);
    toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼†èª­è¾¼ã—ã¾ã—ãŸ');
  }catch(e){
    toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šJSONãŒä¸æ­£ã§ã™');
  }
}
function wipeAll(){
  if(!confirm('æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰')) return;
  localStorage.removeItem(SAVE_KEY);
  location.reload();
}
function ascend(){
  const gain = Math.floor(state.maxFloor / 30);
  if(gain<=0){ toast('è»¢ç”Ÿã§ãã‚‹ã»ã©é€²ã‚“ã§ã„ã¾ã›ã‚“'); return; }
  if(!confirm(`è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿç²å¾—ã‚½ã‚¦ãƒ«ï¼š${gain}`)) return;
  state.souls += gain;
  const keepBest = Math.max(state.bestMaxFloor, state.maxFloor);
  const keepSouls = state.souls;
  Object.assign(state, {
    gold:0, level:1, exp:0, expToNext:20,
    floor:1, maxFloor:1, kills:0, deaths:0,
    baseATK:1, baseHP:10, baseDEF:0, baseCRIT:5,
    autoTap:0,
    eq:{weapon:null, armor:null, ring:null},
    inv:[], autoEquip: state.autoEquip,
    monster:null, playerHP:10, bossEndsAt:0,
    souls: keepSouls, bestMaxFloor: keepBest,
  });
  prices.atk=10; prices.hp=10; prices.auto=25;
  spawnMonster(); updateUI(); renderInventory();
  toast('è»¢ç”Ÿï¼æ’ä¹…ãƒœãƒ¼ãƒŠã‚¹ãŒå¼·åŒ–ã•ã‚Œã¾ã—ãŸ');
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¿ãƒƒãƒ—ã®ã¿ï¼‰ ===== */
ui.attackBtn.addEventListener('click', attack);
$('#monster').addEventListener('click', attack);
/* â˜… ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆSpace/Enterï¼‰ãƒãƒ³ãƒ‰ãƒ©ã¯å‰Šé™¤ */
// $('#monster').addEventListener('keydown', ... ); â†å‰Šé™¤

ui.nextBtn.addEventListener('click', ()=>{ state.floor+=1; spawnMonster(); updateUI(); });
ui.fleeBtn.addEventListener('click', ()=>{ state.floor = Math.max(1, state.floor-1); spawnMonster(); updateUI(); });

ui.buyAtk.addEventListener('click', ()=>buy('atk', ()=>{ state.baseATK+=1; }));
ui.buyHP.addEventListener('click', ()=>buy('hp', ()=>{ state.baseHP+=5; state.playerHP = recalcPlayerMaxHP(); }));
ui.buyAuto.addEventListener('click', ()=>buy('auto', ()=>{ state.autoTap = parseFloat((state.autoTap+0.2).toFixed(1)); }));

ui.autoEquip.addEventListener('change', (e)=>{ state.autoEquip = e.target.checked; });

ui.saveBtn.addEventListener('click', ()=>save(true));
ui.loadBtn.addEventListener('click', ()=>load(true));
ui.exportBtn.addEventListener('click', exportSave);
ui.importBtn.addEventListener('click', importSave);
ui.wipeBtn.addEventListener('click', wipeAll);

ui.ascendBtn.addEventListener('click', ascend);

ui.tabs.forEach(t=>{
  t.addEventListener('click', ()=>{
    ui.tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id = t.dataset.tab;
    [ui.tabUpg, ui.tabInv, ui.tabSta, ui.tabSys].forEach(el=>el.hidden=true);
    document.getElementById(id).hidden=false;
  });
});

/* ===== ãƒ«ãƒ¼ãƒ— ===== */
let last = performance.now();
function loop(now){
  const dt = Math.min(0.1, (now-last)/1000);
  last = now;

  autoTapTick(dt);
  enemyTick(dt);
  regenTick(dt);
  bossTimerTick();
  updateUI();

  requestAnimationFrame(loop);
}

/* ===== èµ·å‹• ===== */
(function init(){
  load(false);
  if(!state.monster) spawnMonster();
  renderInventory();
  updateUI();
  requestAnimationFrame(loop);
  setInterval(()=>save(false), 10_000);
  window.addEventListener('beforeunload', ()=>save(false));
})();
</script>
</body>
</html>