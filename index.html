<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPG</title>
<meta name="theme-color" content="#0f1220">
<style>
  :root{ --c-bg:#0b0f1f;--c-panel:#171a2b;--c-text:#e8eefc;--c-sub:#aab6d6;--c-danger:#ff6b6b;--c-gold:#ffd76a;--c-accent:#6eb6ff; --bg1:#0b0f1f; --bg2:#0a0d1a; --monster1:#141937; --monster2:#101635; --t-accent:#6eb6ff; --footer-h:128px; }
  *{box-sizing:border-box}
  html,body{height:100%;-webkit-text-size-adjust:100%;touch-action:manipulation}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--c-text);-webkit-tap-highlight-color:transparent}
  [hidden]{display:none !important}
  header{position:sticky;top:0;z-index:30;background:#0d1120cc;backdrop-filter:blur(6px);border-bottom:1px solid #1f2440;padding:.6rem .8rem}
  .topbar{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
  .wrap{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
  .pill{background:#171a2b;border:1px solid #232742;border-radius:12px;padding:.45rem .6rem;font-size:.92rem;color:var(--c-sub)}
  .bar{width:160px;height:12px;border-radius:8px;background:#101425;border:1px solid #283055;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#2ddf7f,#67e3a3);width:100%}
  .small{font-size:.85rem;color:var(--c-sub)}
  .toggle{justify-self:end;background:#121639;border:1px solid #2a2f66;color:#c9d6ff;padding:.45rem .6rem;border-radius:10px}
  .toggle[aria-expanded='true']{background:#1a2053}
  main{max-width:1200px;margin:0 auto;padding:1rem; padding-bottom:calc(var(--footer-h) + 24px + env(safe-area-inset-bottom));}
  .layout{display:grid;grid-template-columns:1.2fr .9fr;gap:1rem}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}
  .panel{background:#171a2b;border:1px solid #222647;border-radius:14px;padding:1rem;box-shadow:0 8px 24px #00000045,inset 0 1px #2b3159}
  .monster{position:relative;display:grid;gap:.6rem;justify-items:center;text-align:center;padding:1rem;border-radius:12px;background:radial-gradient(80% 80% at 50% 30%, var(--monster1), var(--monster2));border:1px solid #202554;user-select:none;transition:background .3s ease}
  .floor-badge{position:absolute;left:.6rem;top:.6rem;background:#0f1536;border:1px solid color-mix(in oklab, var(--t-accent), #000 65%);border-radius:10px;padding:.2rem .5rem;font-size:.85rem;color:#cfe0ff}
  .monster-emoji{font-size:76px;line-height:1}
  .hpbar{width:100%;height:18px;background:#0c1026;border:1px solid #2a2f5a;border-radius:10px;overflow:hidden}
  .hpbar>div{height:100%;background:linear-gradient(90deg,#ff6b6b,#ff9f6b);width:100%;transition:width .12s ease}
  .monster-info{display:flex;justify-content:space-between;width:100%;color:#aab6d6;font-weight:600}
  .actions{display:flex;gap:.8rem;flex-wrap:wrap;justify-content:center}
  .btn{background:#0f1536;color:#cfe0ff;border:1px solid color-mix(in oklab, var(--t-accent), #000 65%);padding:.8rem 1.1rem;border-radius:12px;cursor:pointer;min-width:44px;min-height:44px}
  .btn:hover{background:color-mix(in oklab, var(--t-accent), #0f1536 80%)}
  .btn.gold{border-color:#6e5a25;background:#221b08;color:#ffd76a}
  .btn.danger{border-color:#6b2833;background:#2a0d14;color:#ffb0b0}
  .btn:disabled{opacity:.5;filter:grayscale(40%);cursor:not-allowed}
  .btn.mini{padding:.35rem .55rem;border-radius:10px;font-size:.85rem}
  .grid{display:grid;gap:.6rem}
  .inv-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.6rem}
  .card{background:#0f1433;border:1px solid color-mix(in oklab, var(--t-accent), #000 65%);border-radius:10px;padding:.7rem;display:grid;gap:.35rem}
  .row{display:flex;justify-content:space-between;gap:.6rem;align-items:center;flex-wrap:wrap}
  .muted{color:var(--c-sub)}.warn{color:var(--c-danger)}.gold{color:var(--c-gold)}
  .section-title{font-weight:700;margin:.2rem 0}

  #flavorBar{background:#0d1120cc;border-bottom:1px solid color-mix(in oklab, var(--t-accent), #000 60%);backdrop-filter:blur(6px);padding:.4rem .8rem}
  #flavorText{font-weight:700;text-align:center;color:#dbe6ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  #mainFooter{position:fixed;left:0;right:0;bottom:0;z-index:20;background:#0d1120f0;backdrop-filter:blur(8px);border-top:1px solid color-mix(in oklab, var(--t-accent), #000 60%);box-shadow:0 -8px 24px rgba(0,0,0,.35);padding-bottom:max(10px, env(safe-area-inset-bottom))}
  #mainFooter .footer-wrap{display:grid;grid-template-columns:repeat(5,1fr);gap:.4rem;max-width:1200px;margin:0 auto;padding:.6rem .6rem .30rem}
  .ftab{background:#121639;border:1px solid color-mix(in oklab, var(--t-accent), #000 65%);color:#cfe0ff;padding:.65rem .6rem;border-radius:10px;font-weight:700;cursor:pointer}
  .ftab.active{background:color-mix(in oklab, var(--t-accent), #121639 82%);outline:2px solid color-mix(in oklab, var(--t-accent), #fff 20%)}

  #startOverlay{position:fixed;inset:0;z-index:9999}

  .archbar{position:absolute;right:.6rem;top:2rem;background:#2a1030;border:1px solid #5a2f66;color:#ffd6ff;border-radius:10px;padding:.2rem .45rem;font-size:.82rem}

  #floorMenuBtn{position:absolute;right:.6rem;top:.6rem;background:#0f1536;border:1px solid color-mix(in oklab, var(--t-accent), #000 65%);color:#cfe0ff;border-radius:10px;padding:.25rem .5rem;font-weight:700;cursor:pointer}
  #floorMenu{position:absolute;right:.6rem;top:2.4rem;background:#101530;border:1px solid color-mix(in oklab, var(--t-accent), #000 60%);border-radius:12px;box-shadow:0 10px 28px #0009;padding:.55rem;display:grid;gap:.55rem;z-index:25;min-width:230px}
  #floorMenu .row{gap:.45rem}
  #floorMenu input{background:#0b0f25;color:#cfe0ff;border:1px solid color-mix(in oklab, var(--t-accent), #000 60%);border-radius:8px;padding:.45rem}

  .range{appearance:none;width:100%;height:8px;border-radius:6px;background:#0b0f25;border:1px solid color-mix(in oklab, var(--t-accent), #000 60%)}
  .range::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#cfe0ff;border:1px solid color-mix(in oklab, var(--t-accent), #000 60%)}

  .tabline{display:flex;gap:.4rem;flex-wrap:wrap;margin:.2rem 0}
  .subtab,.advtab{background:#121639;border:1px solid color-mix(in oklab, var(--t-accent), #000 65%);color:#cfe0ff;padding:.4rem .6rem;border-radius:10px;cursor:pointer}
  .subtab.active,.advtab.active{background:color-mix(in oklab, var(--t-accent), #121639 82%)}

  /* è»¢ç”Ÿçµæœãƒ¢ãƒ¼ãƒ€ãƒ« */
  #ascModal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:10000}
  #ascBox{background:#161a2b;border:1px solid #2a2f66;border-radius:14px;box-shadow:0 16px 48px #0009;padding:16px;max-width:520px;width:min(92vw,520px)}
  #ascBox .t{font-weight:800;margin-bottom:.4rem}
  #ascBox .s{font-size:.9rem;color:#aab6d6}
</style>
</head>
<body>

<!-- ===== Start ===== -->
<div id="startOverlay">
  <div class="start-bg" style="position:absolute;inset:0;background:linear-gradient(180deg,#0c1224,#090e1a 60%,#0b0f1f)"></div>
  <div class="start-wrap" style="position:relative;display:flex;align-items:center;justify-content:center;width:100%;min-height:100dvh;padding:28px">
    <div class="start-box" style="width:min(720px,92vw);display:grid;gap:1rem;justify-items:center;text-align:center;background:#151a2eaa;border:1px solid rgba(42,47,102,.95);border-radius:14px;backdrop-filter:blur(6px);box-shadow:0 16px 48px #0008;padding:20px">
      <div class="game-title" id="startTitle" style="font-size:28px;font-weight:800;letter-spacing:.02em;line-height:1.15">ãƒã‚¯ã‚¹ãƒ©ãƒ»ã‚¿ãƒƒãƒ—RPG</div>
      <div class="title-logo" id="titleLogo" style="font-size:26px">âš”ï¸ ğŸ›¡ï¸ ğŸ’</div>
      <div class="hint">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼š<span id="verText">1.0</span> ï¼ ã‚»ãƒ¼ãƒ–æ¤œå‡ºï¼š<span id="saveDetect" class="badge" style="display:inline-block;background:#0f1536;border:1px solid #2a2f66;padding:.2rem .5rem;border-radius:10px;color:#cfe0ff">â€¦</span></div>

      <div class="start-actions" style="display:grid;gap:.6rem;width:min(580px,92vw)">
        <div class="row" style="gap:.6rem;justify-content:center">
          <button id="btnPrimary" class="bigbtn" data-mode="local" style="padding:.9rem 1.1rem;border-radius:14px;background:#121639;border:1px solid #2a2f66;color:#cfe0ff;font-weight:700;cursor:pointer;min-width:180px">ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼</button>
          <button id="btnStartImportFile" class="bigbtn" style="padding:.9rem 1.1rem;border-radius:14px;background:#0b122e;border:1px solid #2a2f66;color:#cfe0ff;font-weight:700;cursor:pointer;min-width:180px">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button>
        </div>

        <input id="fileOpenStart" type="file" accept="application/json" hidden>

        <div id="newWrap" style="display:block">
          <div class="divider" style="height:1px;background:#2a2f66;width:100%;opacity:.6;margin:.3rem 0"></div>
          <div class="inline" style="display:flex;gap:.5rem;align-items:center;justify-content:center"><label for="startName" style="font-weight:700;line-height:1.2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </label><input id="startName" class="input" maxlength="20" placeholder="æœªå…¥åŠ›ãªã‚‰ã€æ—…äººã€ã§é–‹å§‹" style="background:#0b0f25;color:#cfe0ff;border:1px solid #2a2f66;border-radius:8px;padding:.55rem"></div>
          <div class="inline" style="display:flex;gap:.5rem;align-items:center;justify-content:center"><button id="btnBegin" class="btn">ã¯ã˜ã‚ã‚‹</button></div>
          <div class="small" id="startNote" style="opacity:.9"></div>
          <div class="small" id="startError"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- è»¢ç”Ÿçµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="ascModal">
  <div id="ascBox">
    <div class="t">è»¢ç”Ÿå®Œäº†ï¼</div>
    <div class="small">ç²å¾—ã‚½ã‚¦ãƒ«ï¼š<b id="ascSoulGained">0</b></div>
    <div class="small">ä»Šãƒ©ã‚¦ãƒ³ãƒ‰åˆ°é”ï¼š<b id="ascRoundReached">1</b> éš</div>
    <div class="s">é€šç®—æœ€é«˜åˆ°é”ï¼š<b id="ascBestReached">1</b> éš</div>
    <div class="row" style="margin-top:.6rem;justify-content:flex-end"><button class="btn" id="ascClose">é–‰ã˜ã‚‹</button></div>
  </div>
</div>

<header>
  <div class="topbar">
    <div class="wrap" id="top-collapsed">
      <div class="pill">æ‰€æŒ <span class="gold"><b id="c-gold">0</b> G</span></div>
      <div class="pill">Lv <b id="c-level">1</b></div>
      <div class="pill">EXP <b id="c-exp">0/20</b></div>
    </div>
    <button id="toggleInfo" class="toggle" aria-expanded="false" aria-controls="top-expanded">â–¼ è©³ç´°</button>
    <div class="wrap" id="top-expanded" hidden>
      <div class="pill">éšå±¤ <b id="x-floor">1</b></div>
      <div class="pill">Lv <b id="x-level">1</b></div>
      <div class="pill">EXP <b id="x-exp">0/20</b></div>
      <div class="pill">HP <span class="bar"><span id="x-hpbar" style="width:100%"></span></span> <span class="small" id="x-hptext">10/10</span></div>
      <div class="pill">ATK <b id="x-atk">1</b></div>
      <div class="pill">æ‰€æŒ <span class="gold"><b id="x-gold">0</b> G</span></div>
      <div class="pill">ã‚½ã‚¦ãƒ« <b id="x-souls">0</b></div>
      <div class="pill">ã‚¯ãƒªç‡ <b id="x-crit">5%</b></div>
      <div class="pill"><span class="small" id="timerAll"></span></div>
    </div>
  </div>
</header>

<!-- â–¼ ãƒ˜ãƒƒãƒ€ãƒ¼ä¸‹ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ -->
<div id="flavorBar"><div id="flavorText">â€”</div></div>

<main>
  <div class="layout">

    <!-- ===== Left: Monster & Floor ===== -->
    <section class="panel">
      <div id="monster" class="monster" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ”»æ’ƒ">
        <!-- åœ°åä½µè¨˜ï¼šä¾‹ã€Œéšå±¤ 31 ã‚¢ã‚ºãƒã®æ£®ï¼ˆæ£®ï¼‰ã€ -->
        <div class="floor-badge" id="floorBadge">éšå±¤ 1 <span class="theme-badge" id="themeBadge">â€”</span></div>
        <button id="floorMenuBtn" title="éšå±¤ç§»å‹•">â†• éšå±¤</button>
        <div id="floorMenu" hidden>
          <div class="row" style="justify-content:flex-start">
            <button class="btn mini" id="fmPrev">1éšæˆ»ã‚‹</button>
            <button class="btn mini gold" id="fmNext">æ¬¡ã¸</button>
          </div>
          <label class="small"><input type="checkbox" id="fmStay"> ã“ã®éšå±¤ã«ç•™ã¾ã‚‹</label>
          <div class="row" style="justify-content:flex-start">
            <input id="fmJumpInput" type="number" min="1" step="1" placeholder="éšå±¤" style="width:120px">
            <button class="btn mini" id="fmJumpGo">ç§»å‹•</button>
          </div>
          <div class="small muted" id="fmHint"></div>
        </div>
        <div id="archBadge" class="archbar" hidden>éšœå£ 0/0</div>

        <div class="monster-emoji" id="monsterFace" aria-hidden="true">ğŸ‘ï¸</div>
        <div class="hpbar" aria-label="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼HP"><div id="monsterHP" style="width:100%"></div></div>
        <div class="monster-info"><span id="monsterName">Lv1 ã‚´ãƒ–ãƒªãƒ³</span><span id="monsterHPText">10 / 10</span></div>

        <div id="logbox" aria-live="polite" aria-atomic="false">
          <div class="logrow" id="log0"></div>
          <div class="logrow" id="log1"></div>
          <div class="logrow" id="log2"></div>
        </div>

        <div class="actions"><button class="btn" id="attackBtn">æˆ¦é—˜é–‹å§‹ï¼</button></div>
      </div>

      <div class="footnote" id="footnoteBoss">10éšã”ã¨ã«ãƒœã‚¹ï¼ˆ<span class="warn">åˆ¶é™30ç§’</span>ï¼‰ã€‚<br>30éšã”ã¨ã«<strong>ç‰¹åˆ¥ãƒœã‚¹</strong>ï¼ˆ<span class="warn">åˆ¶é™60ç§’ï¼‹éšœå£ã‚®ãƒŸãƒƒã‚¯</span>ï¼‰ã€‚</div>
    </section>

    <!-- ===== Right: Panels ===== -->
    <section class="panel">

      <!-- å¼·åŒ– -->
      <div id="tab-upg" class="grid">
        <div class="tab-row"><div class="small muted">å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div><div class="small">æ‰€æŒ <b id="upgGold">0</b> G</div></div>
        <div class="card"><div class="row"><div><b>æ”»æ’ƒåŠ›å¼·åŒ–</b><div class="small muted" id="countAtk">è³¼å…¥å›æ•°ï¼š0</div><div class="small muted">ã‚¯ãƒªãƒƒã‚¯ä¸ãƒ€ãƒ¡ã‚’å¢—åŠ </div></div><div class="gold"><b id="costAtk">10</b> G</div></div>
          <div class="row" style="justify-content:flex-start;gap:.4rem">
            <button class="btn" id="buyAtk">è³¼å…¥ (+1 ATK) / Lv <b id="lvAtk">0</b></button>
            <button class="btn mini" data-bulk="atk-10">Ã—10</button>
            <button class="btn mini" data-bulk="atk-100">Ã—100</button>
            <button class="btn mini" data-bulk="atk-max">MAX</button>
          </div>
        </div>
        <div class="card"><div class="row"><div><b>æœ€å¤§HPå¼·åŒ–</b><div class="small muted" id="countHP">è³¼å…¥å›æ•°ï¼š0</div><div class="small muted">è€ä¹…ã‚’å¢—åŠ </div></div><div class="gold"><b id="costHP">10</b> G</div></div>
          <div class="row" style="justify-content:flex-start;gap:.4rem">
            <button class="btn" id="buyHP">è³¼å…¥ (+5 HP) / Lv <b id="lvHP">0</b></button>
            <button class="btn mini" data-bulk="hp-10">Ã—10</button>
            <button class="btn mini" data-bulk="hp-100">Ã—100</button>
            <button class="btn mini" data-bulk="hp-max">MAX</button>
          </div>
        </div>
        <div class="card"><div class="row"><div><b>è‡ªå‹•ã‚¿ãƒƒãƒ—</b><div class="small muted" id="countAuto">è³¼å…¥å›æ•°ï¼š0</div><div class="small muted">æ¯ç§’è‡ªå‹•æ”»æ’ƒï¼ˆATKã«ä¾å­˜ï¼‰</div></div><div class="gold"><b id="costAuto">25</b> G</div></div>
          <div class="row" style="justify-content:flex-start;gap:.4rem">
            <button class="btn" id="buyAuto">è³¼å…¥ (+0.2 ã‚¿ãƒƒãƒ—/ç§’) / Lv <b id="lvAuto">0</b></button>
            <button class="btn mini" data-bulk="auto-10">Ã—10</button>
            <button class="btn mini" data-bulk="auto-100">Ã—100</button>
            <button class="btn mini" data-bulk="auto-max">MAX</button>
          </div>
          <div class="small muted">ç¾åœ¨ï¼š<b id="autoRate">0.0</b> ã‚¿ãƒƒãƒ—/ç§’</div>
        </div>
      </div>

      <!-- è£…å‚™ï¼ˆç·¨æˆï¼å¼·åŒ– + ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰ -->
      <div id="tab-inv" class="grid" hidden>
        <div class="card">
          <div class="tabline">
            <button class="subtab active" data-eqtab="eq-manage">ç·¨æˆ</button>
            <button class="subtab" data-eqtab="eq-enhance">å¼·åŒ–</button>
          </div>

          <div id="eq-manage">
            <div class="equip-grid" style="margin-top:.4rem">
              <div class="row"><div>æ­¦å™¨ï¼š<span id="fm-weapon">ãªã—</span></div><div class="wrap" style="gap:.4rem"><button class="btn mini" data-change="weapon">å¤‰æ›´</button><button class="btn mini" data-unequip="weapon">å¤–ã™</button></div></div>
              <div class="row"><div>é§ã€€ï¼š<span id="fm-armor">ãªã—</span></div><div class="wrap" style="gap:.4rem"><button class="btn mini" data-change="armor">å¤‰æ›´</button><button class="btn mini" data-unequip="armor">å¤–ã™</button></div></div>
              <div class="row"><div>è£…é£¾å“ï¼š<span id="fm-ring">ãªã—</span></div><div class="wrap" style="gap:.4rem"><button class="btn mini" data-change="ring">å¤‰æ›´</button><button class="btn mini" data-unequip="ring">å¤–ã™</button></div></div>
            </div>

            <div class="card" id="chooserCard" hidden style="margin-top:.6rem">
              <div class="section-title" id="chooserTitle">é¸æŠ</div>
              <div class="chooser" id="chooserList"></div>
            </div>

            <div class="card" style="margin-top:.6rem">
              <div class="tabline">
                <button class="subtab active" data-uniqtab="uniq-list">ãƒ¦ãƒ‹ãƒ¼ã‚¯è£…å‚™ä¸€è¦§</button>
                <button class="subtab" data-uniqtab="uniq-forge">ç¥å™¨éŒ¬æˆ</button>
              </div>
              <div id="uniq-list">
                <div class="small" id="uniqListBox">ï¼ˆä¸€è¦§ã‚’ç”Ÿæˆä¸­â€¦ï¼‰</div>
              </div>
              <div id="uniq-forge" hidden>
                <!-- â˜…ä¸€æ‹¬éŒ¬æˆã‚’æœ€ä¸Šéƒ¨ -->
                <div class="row" style="gap:.6rem;align-items:center;margin:.2rem 0 .6rem">
                  <button class="btn danger" id="bulkForgeBtn">ä¸€æ‹¬éŒ¬æˆï¼ˆã•ã•ã’ã‚‹ï¼‰</button>
                  <div class="small warn" id="bulkForgeNote">è£…å‚™ä¸­ï¼‹ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ä»¥ä¸‹ã‚’<b>å…¨ã¦</b>æ¶ˆè²»ï¼ˆ<b id="bulkCount">0</b>ä»¶ï¼‰ã€‚ãƒ¦ãƒ‹ãƒ¼ã‚¯/æ°¸ç¶šã¯é™¤å¤–ã€‚</div>
                </div>
                <div class="small" id="relicSwordInfo">â€”</div>
                <div class="chooser" id="demonList" style="margin-top:.4rem"></div>
              </div>
            </div>
          </div>

          <div id="eq-enhance" hidden>
            <div class="card">
              <div class="section-title">æ­¦å™¨ã®å¼·åŒ–</div>
              <div class="small" id="enhWInfo">æ­¦å™¨æœªè£…å‚™</div>
              <div class="row" style="gap:.6rem"><button class="btn" id="enhWBtn" disabled>å¼·åŒ–ï¼ˆãã‚‰çŸ³ x <b id="enhWCost">0</b>ï¼‰</button></div>
            </div>
            <div class="card">
              <div class="section-title">é§ã®å¼·åŒ–</div>
              <div class="small" id="enhAInfo">é§æœªè£…å‚™</div>
              <div class="row" style="gap:.6rem"><button class="btn" id="enhABtn" disabled>å¼·åŒ–ï¼ˆãã‚‰çŸ³ x <b id="enhACost">0</b>ï¼‰</button></div>
            </div>
            <div class="card">
              <div class="section-title">è£…é£¾å“ã®å¼·åŒ–</div>
              <div class="small" id="enhRInfo">è£…é£¾å“æœªè£…å‚™</div>
              <div class="row" style="gap:.6rem"><button class="btn" id="enhRBtn" disabled>å¼·åŒ–ï¼ˆãã‚‰çŸ³ x <b id="enhRCost">0</b>ï¼‰</button></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row"><b>æ‰€æŒå“ï¼ˆé–²è¦§ã®ã¿ï¼‰</b><label class="small"><input type="checkbox" id="autoEquip" /> å¼·ã„è£…å‚™ã‚’è‡ªå‹•è£…å‚™</label></div>
          <div class="inv-list" id="invList"></div>
        </div>
      </div>

      <!-- çµ±è¨ˆï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ï¼é€šç®—ï¼‰ -->
      <div id="tab-sta" class="grid" hidden>
        <div class="card">
          <div class="section-title">ã‚¹ã‚³ã‚¢</div>
          <div class="small">ã„ã‚ã‚“ãªæ•°å­—ã‚’é©å½“ã«è¶³ã—è¾¼ã‚“ã ç›®å®‰å€¤ï¼š<b id="sta-score">0</b></div>
        </div>
        <div class="card">
          <div class="section-title">ãƒ©ã‚¦ãƒ³ãƒ‰è¨˜éŒ²</div>
          <div class="small">ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜åˆ°é”ï¼š<b id="sta-roundmax">1</b></div>
          <div class="small">è¨ä¼æ•°ï¼ˆä»Šãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰ï¼š<b id="sta-kills">0</b></div>
          <div class="small">æ­»äº¡æ•°ï¼ˆä»Šãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰ï¼š<b id="sta-deaths">0</b></div>
        </div>
        <div class="card">
          <div class="section-title">é€šç®—è¨˜éŒ²</div>
          <div class="small">é€šç®—æœ€é«˜åˆ°é”ï¼š<b id="sta-bestmax">1</b></div>
          <div class="small">è»¢ç”Ÿå›æ•°ï¼š<b id="sta-asc">0</b></div>
        </div>
        <div class="card">
          <div class="section-title">èƒ½åŠ›ãƒ»ãã®ä»–</div>
          <div class="small">ATKï¼š<b id="sta-atk">1</b>ï¼æœ€å¤§HPï¼š<b id="sta-hp">10</b>ï¼é˜²å¾¡ï¼š<b id="sta-def">0</b></div>
          <div class="small">ã‚¯ãƒªç‡ï¼š<b id="sta-crit">5%</b>ï¼è‡ªå‹•ã‚¿ãƒƒãƒ—ï¼š<b id="sta-autotap">0.0</b> /ç§’</div>
          <div class="small">ã‚´ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒŠã‚¹ï¼š<b id="sta-goldb">0%</b></div>
          <div class="small">ãƒ‰ãƒ­ãƒƒãƒ—ï¼šè£…å‚™<b id="sta-itemdrop">20%</b>ï¼ãƒŸãƒŸãƒƒã‚¯<b id="sta-mimic">3.00%</b>ï¼SãƒŸãƒŸãƒƒã‚¯<b id="sta-supermimic">1.20%</b></div>
          <div class="small">çŸ³ã“ã‚ï¼š<b id="sta-stonedrop">5%</b>ï¼ˆä¸€åº¦ã«<b id="sta-stoneamt">0</b>å€‹ï¼‰</div>
          <div class="small">æ‰€æŒï¼šã‚´ãƒ¼ãƒ«ãƒ‰<b id="bag-gold">0</b>Gï¼ã‚½ã‚¦ãƒ«<b id="bag-soul">0</b>ï¼ˆç´¯è¨ˆæ¶ˆè²»<b id="bag-soulspent">0</b>ï¼‰ï¼é­”çŸ³<b id="bag-gem">0</b>ï¼ãã‚‰çŸ³<b id="bag-peb">0</b>ï¼è£…å‚™<b id="bag-eq">0</b></div>
        </div>
      </div>

      <!-- è»¢ç”Ÿ/è–éºç‰© -->
      <div id="tab-adv" class="grid" hidden>
        <div class="card">
          <div class="adv-subtabs">
            <button class="advtab active" data-advtab="adv-asc">è»¢ç”Ÿ / ã‚½ã‚¦ãƒ«å¼·åŒ–</button>
            <button class="advtab" data-advtab="adv-relic">è–éºç‰©ï¼ˆé€šå¸¸ï¼‰</button>
            <button class="advtab" data-advtab="adv-relic-test">è–éºç‰©ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰</button>
          </div>
          <div id="adv-asc">
            <div class="section-title">è»¢ç”Ÿï¼ˆãƒ‘ãƒ¼ãƒãƒãƒ³ãƒˆå¼·åŒ–ï¼‰</div>
            <div class="small" id="ascDesc">è»¢ç”Ÿã§ <b>ãƒ¬ãƒ™ãƒ«</b> / <b>å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼</b> / <b>é€šå¸¸è£…å‚™</b> ã‚’<b>å®Œå…¨ãƒªã‚»ãƒƒãƒˆ</b>ã€‚<br>ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜åˆ°é”ã¯ãƒªã‚»ãƒƒãƒˆã€<b>é€šç®—æœ€é«˜åˆ°é”</b>ã¯ä¿æŒã€‚è»¢ç”Ÿå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã€<b>ã‚½ã‚¦ãƒ«</b>ã‚’ç²å¾—ã€‚</div>
            <div class="row"><div>ç²å¾—è¦‹è¾¼ã¿ï¼š<b id="soulGain">0</b> ã‚½ã‚¦ãƒ«</div><button class="btn danger" id="ascendBtn">è»¢ç”Ÿã™ã‚‹</button></div>
            <div class="divider-thin"></div>
            <div class="sectionã‚¿ã‚¤ãƒˆãƒ«">ã‚½ã‚¦ãƒ«å¼·åŒ–ï¼ˆæ’ä¹…ï¼‰</div>
            <div class="small">æ‰€æŒã‚½ã‚¦ãƒ«ï¼š<b id="soulRemain">0</b> ï¼ ç´¯è¨ˆæ¶ˆè²»ï¼š<b id="soulSpent">0</b></div>
            <div class="grid" style="margin-top:.4rem">
              <div class="card"><div class="row"><div><b>æ°¸ç¶šãƒ»æ”»æ’ƒåŠ›</b><div class="small muted">+2% / Lvï¼ˆä¹—ç®—ï¼‰</div></div><div class="small">Lv <b id="soulLvAtk">0</b> ï¼ æ¬¡ã®å¿…è¦ã‚½ã‚¦ãƒ«ï¼š<b id="soulCostAtk">1</b></div></div><div class="row" style="justify-content:flex-start;gap:.4rem"><button class="btn" id="soulBuyAtk">å¼·åŒ–ã™ã‚‹</button></div></div>
              <div class="card"><div class="row"><div><b>æ°¸ç¶šãƒ»æœ€å¤§HP</b><div class="small muted">+2% / Lvï¼ˆä¹—ç®—ï¼‰</div></div><div class="small">Lv <b id="soulLvHP">0</b> ï¼ æ¬¡ã®å¿…è¦ã‚½ã‚¦ãƒ«ï¼š<b id="soulCostHP">1</b></div></div><div class="row" style="justify-content:flex-start;gap:.4rem"><button class="btn" id="soulBuyHP">å¼·åŒ–ã™ã‚‹</button></div></div>
              <div class="card"><div class="row"><div><b>æ°¸ç¶šãƒ»ã‚´ãƒ¼ãƒ«ãƒ‰</b><div class="small muted">+2% / Lvï¼ˆåŠ ç®—ï¼‰</div></div><div class="small">Lv <b id="soulLvGold">0</b> ï¼ æ¬¡ã®å¿…è¦ã‚½ã‚¦ãƒ«ï¼š<b id="soulCostGold">1</b></div></div><div class="row" style="justify-content:flex-start;gap:.4rem"><button class="btn" id="soulBuyGold">å¼·åŒ–ã™ã‚‹</button></div></div>
            </div>
          </div>

          <div id="adv-relic" hidden>
            <div class="card">
              <div class="row"><b>è–éºç‰©ã‚·ãƒ§ãƒƒãƒ—</b><div class="small">è³¼å…¥ã®ãŸã³<b>ãƒ©ãƒ³ãƒ€ãƒ è§£é™¤</b>ï¼ˆã‚³ã‚¹ãƒˆã¯å¾ã€…ã«å¢—åŠ ï¼‰</div></div>
              <div class="row"><div class="small">æ¬¡ã‚³ã‚¹ãƒˆï¼š<b id="relicShopCost">5</b> ã‚½ã‚¦ãƒ«</div><button class="btn" id="relicShopBuy">è³¼å…¥ï¼ˆãƒ©ãƒ³ãƒ€ãƒ è§£é™¤ï¼‰</button></div>
            </div>
            <div class="card" id="relicJarCard" hidden>
              <div class="row"><b>å¼·æ¬²ã®å£º</b><div class="small">Lv <b id="jarLv">0</b> ï¼ æ¬¡ã‚³ã‚¹ãƒˆï¼š<b id="jarCost">2</b> ã‚½ã‚¦ãƒ«</div></div>
              <div class="small">åŠ¹æœï¼šç²å¾—ã‚´ãƒ¼ãƒ«ãƒ‰ +20% / Lvï¼ˆç´¯ç©ï¼‰</div>
              <div class="row" style="gap:.6rem"><button class="btn" id="jarUpgrade">å¼·åŒ–</button></div>
            </div>
            <div class="card" id="relicKnifeCard" hidden>
              <div class="row"><b>ã»ã‚“ã‚‚ã®ã®ãƒŠã‚¤ãƒ•</b><div class="small">Lv <b id="knifeLv">0</b> ï¼ æ¬¡ã‚³ã‚¹ãƒˆï¼š<b id="knifeCost">3</b> ã‚½ã‚¦ãƒ«</div></div>
              <div class="small">åŠ¹æœï¼šæ”»æ’ƒåŠ› +99 / Lvï¼ˆå®Ÿæ•°å€¤åŠ ç®—ï¼‰</div>
              <div class="row" style="gap:.6rem"><button class="btn" id="knifeUpgrade">å¼·åŒ–</button></div>
            </div>
          </div>

          <div id="adv-relic-test" hidden>
            <div class="card">
              <b>è–éºç‰©ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰</b>
              <div class="small">â€»ä»Šã ã‘ã‚³ãƒ¼ãƒ‰æ²ç¤ºï¼š<b>kashiwa060925</b>ï¼ˆæŸã®åŠ è­·ï¼‰, <b>kashiwa77</b>ï¼ˆãƒ„ãƒ¨ã‚¹ã‚®ãƒ†=ã‚¯ã‚µãƒã‚¨ãƒ«ï¼‰</div>
            </div>
            <div class="card" id="relicKashiwaCard" hidden>
              <div class="row"><b>æŸã®åŠ è­·ï¼ˆã‚³ãƒ¼ãƒ‰ç‰¹å…¸ï¼‰</b><label class="small"><input type="checkbox" id="relicKashiwa"> æœ‰åŠ¹åŒ–</label></div>
              <div class="small">ã‚ªãƒ¼ãƒãƒ¼ã‚­ãƒ«åˆ†ã ã‘é€£ç¶šè¨ä¼ã€‚ã¾ã¨ã‚ã¦å€’ã—ãŸã¨ãã¯GMãŒåå¿œã™ã‚‹ã€‚</div>
            </div>
            <div class="card" id="relicStrongSwordCard" hidden>
              <div class="row"><b>ãƒ„ãƒ¨ã‚¹ã‚®ãƒ†=ã‚¯ã‚µãƒã‚¨ãƒ«ï¼ˆã‚³ãƒ¼ãƒ‰ç‰¹å…¸ï¼‰</b><label class="small"><input type="checkbox" id="relicStrongSword"> æœ‰åŠ¹åŒ–</label></div>
              <div class="small">æ”»æ’ƒåŠ›ã‚’<b>99å€</b>ã«ã™ã‚‹</div>
            </div>
          </div>
        </div>
      </div>

      <!-- è¨­å®š/ã‚»ãƒ¼ãƒ– -->
      <div id="tab-settings" class="grid" hidden>
        <div class="card"><b>ã‚»ãƒ¼ãƒ–</b>
          <div class="row" style="gap:.4rem;align-items:center"><input id="exportName" class="input" placeholder="ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆçœç•¥æ™‚ï¼šsave-ãƒ¦ãƒ¼ã‚¶ãƒ¼å-YYYYMMDD-HHMMSS.jsonï¼‰" style="flex:1" /><button class="btn" id="downloadBtn">ä»Šã™ããƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button></div>
          <div class="small muted">â€»ç¾åœ¨ã®çŠ¶æ…‹ã‚’<b>ç›´æ¥JSON</b>ã¨ã—ã¦ä¿å­˜ï¼ˆlocalStorageã«ã‚‚åŒæ™‚ä¿å­˜ï¼‰ã€‚</div>
        </div>
        <div class="card"><b>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</b>
          <div class="row" style="gap:.6rem;align-items:center"><button class="btn" id="importFileBtn">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿</button><input id="fileOpenSettings" type="file" accept="application/json" hidden></div>
        </div>
        <div class="card"><b>ã‚µã‚¦ãƒ³ãƒ‰ / ãƒã‚¤ãƒ–è¨­å®š</b>
          <div class="row" style="gap:.6rem;align-items:center">
            <label><input type="checkbox" id="audioEnabled"> ã‚µã‚¦ãƒ³ãƒ‰æœ‰åŠ¹</label>
            <label><input type="checkbox" id="hapticEnabled"> ãƒã‚¤ãƒ–</label>
            <label><input type="checkbox" id="bgmBoss"> 30éšãƒœã‚¹BGM</label>
          </div>
          <div class="row" style="gap:.6rem;align-items:center">
            <label style="flex:1">SE éŸ³é‡ <input id="seVol" class="range" type="range" min="0" max="100" value="80"></label>
          </div>
        </div>
        <div class="card"><b>ãã®ä»–</b>
          <div class="row" style="gap:.6rem"><button class="btn danger" id="wipeBtn">å…¨å‰Šé™¤/æ›´æ–°</button></div>
          <div class="small warn">â€»å‰Šé™¤å‰ã«å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¦ãã ã•ã„</div>
        </div>
        <div class="card"><b>ã‚³ãƒ¼ãƒ‰å¼•ãæ›ãˆ</b>
          <div class="row"><input id="codeInput" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" class="input" style="flex:1;min-width:160px"/><button class="btn" id="codeBtn">å¼•ãæ›ãˆ</button></div>
          <div class="small muted" id="codeStatus"></div>
        </div>
        <div class="card"><b>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </b>
          <div class="row" style="gap:.6rem;align-items:center"><input id="nameEdit" class="input" maxlength="20" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ " style="flex:1"><button class="btn" id="nameSave">ä¿å­˜</button></div>
        </div>
      </div>

    </section>
  </div>
</main>

<footer id="mainFooter" role="navigation" aria-label="ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
  <div class="footer-wrap">
    <button class="ftab active" data-tab="tab-upg" aria-controls="tab-upg" aria-label="å¼·åŒ–">å¼·åŒ–</button>
    <button class="ftab" data-tab="tab-inv" aria-controls="tab-inv" aria-label="è£…å‚™">è£…å‚™</button>
    <button class="ftab" data-tab="tab-sta" aria-controls="tab-sta" aria-label="çµ±è¨ˆ">çµ±è¨ˆ</button>
    <button class="ftab" data-tab="tab-adv" aria-controls="tab-adv" aria-label="è»¢ç”Ÿ/è–éºç‰©">è»¢ç”Ÿ</button>
    <button class="ftab" data-tab="tab-settings" aria-controls="tab-settings" aria-label="è¨­å®š/ã‚»ãƒ¼ãƒ–">è¨­å®š</button>
  </div>
</footer>

<script>
"use strict";
const GAME_VERSION='1.0';
const SAVE_KEY='tap_hns_save_v100', UI_MODE='ui_top_mode_v7', AUDIO_KEY='tap_hns_audio_v5', STAGE_KEY='tap_hns_stage_v1';
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const on=(el,ev,fn,opt)=>{ if(el) el.addEventListener(ev,fn,opt) };

// ===== State =====
const state={ gold:0, level:1, exp:0, expToNext:20, floor:1,
  roundMaxFloor:1, bestMaxFloor:1,
  kills:0, deaths:0, ascCount:0,
  baseATK:1, baseHP:10, baseDEF:0, baseCRIT:5, autoTap:0,
  eq:{weapon:null,armor:null,ring:null}, inv:[], autoEquip:false,
  monster:null, playerHP:10, bossEndsAt:0, souls:0, soulsSpent:0,
  soulUp:{atk:0,hp:0,gold:0}, isDown:false, engaged:false, reviveAt:0, stay:false,
  pebbles:0, magicStones:0, upg:{atk:0,hp:0,auto:0},
  unlocks:{kashiwa:false, strongsword:false}, relicActive:{kashiwa:false, strongsword:false},
  relics:{shopCost:5, jar:{unlocked:false,lvl:0}, knife:{unlocked:false,lvl:0}},
  uniqueWeapon:{base:0,feeds:0,exists:false},
  flavorIdx:0, invFilter:'all', themes:{}, stageNames:{}, username:'', lastSeenVersion:GAME_VERSION };

// ä¾¡æ ¼
const prices={atk:10,hp:10,auto:25};

// ===== UI refs =====
const ui={ startOverlay:$('#startOverlay'), verText:$('#verText'), saveDetect:$('#saveDetect'), btnPrimary:$('#btnPrimary'), btnStartImportFile:$('#btnStartImportFile'), fileOpenStart:$('#fileOpenStart'), startName:$('#startName'), btnBegin:$('#btnBegin'), startNote:$('#startNote'), startError:$('#startError'),
  c_gold:$('#c-gold'), c_level:$('#c-level'), c_exp:$('#c-exp'), x_floor:$('#x-floor'), x_level:$('#x-level'), x_exp:$('#x-exp'), x_hpbar:$('#x-hpbar'), x_hptxt:$('#x-hptext'), x_atk:$('#x-atk'), x_gold:$('#x-gold'), x_souls:$('#x-souls'), x_crit:$('#x-crit'), timerAll:$('#timerAll'), toggleInfo:$('#toggleInfo'), topCollapsed:$('#top-collapsed'), topExpanded:$('#top-expanded'), flavorBar:$('#flavorBar'), flavorText:$('#flavorText'), floorBadge:$('#floorBadge'), themeBadge:$('#themeBadge'), monsterFace:$('#monsterFace'), monsterHP:$('#monsterHP'), monsterHPText:$('#monsterHPText'), monsterName:$('#monsterName'), attackBtn:$('#attackBtn'), floorMenuBtn:$('#floorMenuBtn'), floorMenu:$('#floorMenu'), fmPrev:$('#fmPrev'), fmNext:$('#fmNext'), fmStay:$('#fmStay'), fmJumpInput:$('#fmJumpInput'), fmJumpGo:$('#fmJumpGo'), fmHint:$('#fmHint'),
  tabUpg:$('#tab-upg'), tabInv:$('#tab-inv'), tabSta:$('#tab-sta'), tabAdv:$('#tab-adv'), tabSettings:$('#tab-settings'), costAtk:$('#costAtk'), costHP:$('#costHP'), costAuto:$('#costAuto'), buyAtk:$('#buyAtk'), buyHP:$('#buyHP'), buyAuto:$('#buyAuto'), autoRate:$('#autoRate'), upgGold:$('#upgGold'), lvAtk:$('#lvAtk'), lvHP:$('#lvHP'), lvAuto:$('#lvAuto'), countAtk:$('#countAtk'), countHP:$('#countHP'), countAuto:$('#countAuto'),
  invList:$('#invList'), autoEquip:$('#autoEquip'), fmWeapon:$('#fm-weapon'), fmArmor:$('#fm-armor'), fmRing:$('#fm-ring'), chooserCard:$('#chooserCard'), chooserTitle:$('#chooserTitle'), chooserList:$('#chooserList'),
  eqTabs:$$('#tab-inv .subtab[data-eqtab]'), eqManage:$('#eq-manage'), eqEnhance:$('#eq-enhance'), uniqTabs:$$('#tab-inv .subtab[data-uniqtab]'), uniqList:$('#uniq-list'), uniqForge:$('#uniq-forge'), uniqListBox:$('#uniqListBox'),
  enhWInfo:$('#enhWInfo'), enhAInfo:$('#enhAInfo'), enhRInfo:$('#enhRInfo'), enhWBtn:$('#enhWBtn'), enhABtn:$('#enhABtn'), enhRBtn:$('#enhRBtn'), enhWCost:$('#enhWCost'), enhACost:$('#enhACost'), enhRCost:$('#enhRCost'),
  relicSwordInfo:$('#relicSwordInfo'), demonList:$('#demonList'), bulkForgeBtn:$('#bulkForgeBtn'), bulkForgeNote:$('#bulkForgeNote'), bulkCount:$('#bulkCount'),
  staScore:$('#sta-score'), staAtk:$('#sta-atk'), staHP:$('#sta-hp'), staDef:$('#sta-def'), staCrit:$('#sta-crit'), staGoldB:$('#sta-goldb'), staSatk:$('#sta-satk'), staShp:$('#sta-shp'), staSgold:$('#sta-sgold'),
  staRoundMax:$('#sta-roundmax'), staBestMax:$('#sta-bestmax'), staKills:$('#sta-kills'), staDeaths:$('#sta-deaths'), staAutoTap:$('#sta-autotap'), staItemDrop:$('#sta-itemdrop'), staMimic:$('#sta-mimic'), staSuperMimic:$('#sta-supermimic'), staStoneDrop:$('#sta-stonedrop'), staStoneAmt:$('#sta-stoneamt'), staAsc:$('#sta-asc'),
  bagGold:$('#bag-gold'), bagSoul:$('#bag-soul'), bagSoulSpent:$('#bag-soulspent'), bagGem:$('#bag-gem'), bagPeb:$('#bag-peb'), bagEq:$('#bag-eq'),
  relicShopCost:$('#relicShopCost'), relicShopBuy:$('#relicShopBuy'), relicKashiwaCard:$('#relicKashiwaCard'), relicKashiwa:$('#relicKashiwa'), relicStrongSwordCard:$('#relicStrongSwordCard'), relicStrongSword:$('#relicStrongSword'), jarCard:$('#relicJarCard'), jarLv:$('#jarLv'), jarCost:$('#jarCost'), jarUpgrade:$('#jarUpgrade'), knifeCard:$('#relicKnifeCard'), knifeLv:$('#knifeLv'), knifeCost:$('#knifeCost'), knifeUpgrade:$('#knifeUpgrade'),
  advTabs:$$('.advtab'), advAsc:$('#adv-asc'), advRelic:$('#adv-relic'), advRelicTest:$('#adv-relic-test'),
  soulGain:$('#soulGain'), soulRemain:$('#soulRemain'), soulSpent:$('#soulSpent'), soulLvAtk:$('#soulLvAtk'), soulLvHP:$('#soulLvHP'), soulLvGold:$('#soulLvGold'), soulCostAtk:$('#soulCostAtk'), soulCostHP:$('#soulCostHP'), soulCostGold:$('#soulCostGold'), soulBuyAtk:$('#soulBuyAtk'), soulBuyHP:$('#soulBuyHP'), soulBuyGold:$('#soulBuyGold'),
  codeInput:$('#codeInput'), codeBtn:$('#codeBtn'), codeStatus:$('#codeStatus'), exportName:$('#exportName'), downloadBtn:$('#downloadBtn'), importFileBtn:$('#importFileBtn'), fileOpenSettings:$('#fileOpenSettings'), wipeBtn:$('#wipeBtn'), nameEdit:$('#nameEdit'), nameSave:$('#nameSave'), audioEnabled:$('#audioEnabled'), hapticEnabled:$('#hapticEnabled'), seVol:$('#seVol'), bgmBoss:$('#bgmBoss'), archBadge:$('#archBadge'),
  ascModal:$('#ascModal'), ascClose:$('#ascClose'), ascSoulGained:$('#ascSoulGained'), ascRoundReached:$('#ascRoundReached'), ascBestReached:$('#ascBestReached') };

<!-- ===== Part 2 / 3 : JSï¼ˆç¶šãï¼‰ ===== -->

/* =========================
   è£…å‚™å¼·åŒ–ãƒ»èƒ½åŠ›è¨ˆç®—
   ========================= */
function effWeaponAtk(it){ if(!it||it.slot!=='weapon') return 0; const lv=it.enhlv||0; const base=it.atk||0; return Math.max(1, Math.floor( (base + 5*lv) * (1+0.04*lv) )); }
function effArmorHP(it){ if(!it||it.slot!=='armor') return 0; const lv=it.enhlv||0; const baseHP=it.hp||0; return Math.max(0, Math.floor( (baseHP + 10*lv) * (1+0.05*lv) )); }
function effRing(it){ if(!it||it.slot!=='ring') return {atk:0,crit:0,goldB:0}; const lv=it.enhlv||0; const atk = Math.max(0, Math.floor(((it.atk||0) + 2*lv) * (1+0.03*lv)) ); const crit = (it.crit||0) + lv; const goldB = (it.goldB||0) + 2*lv; return {atk,crit,goldB}; }

function soulAtkMult(){ return 1 + state.soulUp.atk * 0.02 }
function soulHPMult(){ return 1 + state.soulUp.hp  * 0.02 }
function soulGoldBonus(){ return state.soulUp.gold * 2 }
function jarGoldBonus(){ return (state.relics.jar?.lvl||0) * 20 }
function knifeAtkBonus(){ return (state.relics.knife?.lvl||0) * 99 }
function recalcMaxHP(){ const a=state.eq.armor; const armorHP=effArmorHP(a); const base=state.baseHP+armorHP; return Math.max(1,Math.floor(base*soulHPMult())) }
function uniqueSwordName(){ return (state.ascCount>=3)?'é­”å‰£ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰':'éŒ†ã³ãŸå‰£ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰' }
function uniqueSwordATK(){ const base=state.uniqueWeapon?.base||0; const mult=1 + (state.bestMaxFloor||0)*0.01; return Math.floor(base*mult) }
function ensureUniqueSwordItem(){ if(!state.uniqueWeapon) state.uniqueWeapon={base:0,feeds:0,exists:false}; const exists=state.inv.find(it=>it.id==='unique_demon'); if(!exists){ const it={id:'unique_demon', unique:'demon', slot:'weapon', name:uniqueSwordName(), rarity:'Legendary', atk:uniqueSwordATK(), value:0, persist:true}; state.inv.unshift(it); state.uniqueWeapon.exists=true; } else { exists.atk=uniqueSwordATK(); exists.name=uniqueSwordName(); } }
function ringEff(){ const r=state.eq.ring; const e=effRing(r); return e }
function playerATK(){ const wAtk=effWeaponAtk(state.eq.weapon)||0; const rAtk=ringEff().atk||0; let base=Math.max(1,Math.floor((state.baseATK + wAtk + rAtk + knifeAtkBonus())*soulAtkMult())); if(state.relicActive.strongsword) base*=99; return base }
function playerDEF(){ return state.baseDEF+(state.eq.armor?.def||0) }
function playerCRIT(){ return clamp(state.baseCRIT+(ringEff().crit||0),0,100) }
function goldB(){ const rg=(ringEff().goldB||0); return rg + soulGoldBonus() + jarGoldBonus() }

/* =========================
   æ•µã‚¹ã‚±ãƒ¼ãƒ« & ãƒ€ãƒ¡ãƒ¼ã‚¸
   ========================= */
// 30n+1 ãƒ–ãƒ­ãƒƒã‚¯ã¸å…¥ã‚‹ã”ã¨ã« â€œã™ã“ãƒ¼ã—â€ å³ã—ãï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã”ã¨ã« +3% HPã€+2% ATKï¼‰
function diffMultHP(floor){ return 1 + 0.03 * Math.max(0, Math.floor((floor-1)/30)); }
function diffMultATK(floor){ return 1 + 0.02 * Math.max(0, Math.floor((floor-1)/30)); }

function clickDamage(){ const c=Math.random()*100<playerCRIT(); let d=playerATK(); if(c)d=Math.floor(d*1.8); return {dmg:d,isCrit:c} }
function eHP(f,b){ return Math.floor((14*Math.pow(f,1.18)+6)*(b?6:1) * diffMultHP(f)) }
function eGold(f,b){ return Math.floor((4*Math.pow(f,1.10)+2)*(b?4:1)) }
function eATK(f,b){ return Math.floor((1.2*Math.pow(f,1.05)+0.6)*(b?2:1) * diffMultATK(f)) }

/* =========================
   ãƒ­ã‚° / ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼
   ========================= */
const _logBuf=[]; function renderLog(){ for(let i=0;i<3;i++){ const el=document.getElementById(`log${i}`); if(el) el.innerHTML=_logBuf[i]||''; } }
function pushLog(html){ _logBuf.unshift(html); if(_logBuf.length>3)_logBuf.length=3; renderLog(); }
function toast(m){ const t=typeof m==='string'?m.replace(/</g,'&lt;').replace(/>/g,'&gt;'):String(m); pushLog(t); }

const GENERIC_FLAVOR=[ 'é“ã¯ç¶šã„ã¦ã„ã‚‹ã€‚', 'é¢¨ãŒå°‘ã—ã ã‘å‘³æ–¹ã ã€‚', 'ã©ã“ã‹ã§éˆ´ã®éŸ³ãŒã—ãŸæ°—ãŒã™ã‚‹ã€‚', 'èª°ã‹ãŒå›ã®åå‰ã‚’å‘¼ã‚“ã ã‚ˆã†ãªã€‚' ];
let _killFlavorExpiresAt=0, _genericNextAt=0;
function showKillFlavor(txt){ if(!ui.flavorText) return; ui.flavorText.textContent=txt; _killFlavorExpiresAt=Date.now()+3000; }
function updateFlavorBar(){ const now=Date.now(); if(now<_killFlavorExpiresAt){ return } if(now>=_genericNextAt){ ui.flavorText && (ui.flavorText.textContent=choice(GENERIC_FLAVOR)); _genericNextAt=now+15000; } }

// ãƒ†ãƒ¼ãƒåˆ¥æ’ƒç ´ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼
const KILL_FLAVOR={
  plains:[ 'è‰ã¯è¸ã¿ãªã‚‰ã•ã‚Œã€å°é“ãŒä¸€æœ¬ä¼¸ã³ãŸã€‚', 'ç©ºæ°—ãŒå°‘ã—è»½ããªã‚‹ã€‚' ],
  forest:[ 'æ¢¢ã§é³¥ãŒä¸€ç¾½ã€é³´ã„ãŸã€‚', 'æœ¨æ¼ã‚Œæ—¥ãŒæ¿ƒããªã‚‹ã€‚' ],
  desert:[ 'ç ‚å¡µãŒé™ã¾ã£ãŸã€‚', 'é ãã§æ——ãŒä¸€ã¤æºã‚Œã‚‹ã€‚' ],
  undead:[ 'å†·æ°—ãŒä¸€å±¤è–„ã‚ŒãŸã€‚', 'ç¯ãŒã²ã¨ã¤ã€ãµã£ã¨æ˜ã‚‹ããªã‚‹ã€‚' ],
  cave:[ 'æ»´ã‚Šã®ãƒªã‚ºãƒ ãŒæˆ»ã£ãŸã€‚', 'å¥¥ã®éŸ¿ããŒé ã®ãã€‚' ],
  arcane:[ 'åºŠã®é™£ãŒé™ã‹ã«æ¶ˆãˆã‚‹ã€‚', 'æ›¸ã‹ã‚Œãªã„æ–‡ãŒç™½ç´™ã¸æˆ»ã£ãŸã€‚' ]
};
function killFlavorText(monName){ const bi=currentBlockIdx(); const theme=ensureThemeForBlock(bi); const stage=ensureStageNameForBlock(bi,theme); const extra=choice(KILL_FLAVOR[theme]||['é™ã‘ã•ãŒæˆ»ã‚‹ã€‚']); return `${monName} ã‚’å€’ã—ãŸã€‚${extra}` }

/* =========================
   ã‚µã‚¦ãƒ³ãƒ‰ï¼ˆSEï¼‰ï¼‹ 30éšãƒœã‚¹BGM
   ========================= */
let audioCtx=null,_audioReady=false; const AudioStore={enabled:true,seVol:0.8,bgmBoss:true};
function loadAudioSettings(){ try{ const raw=localStorage.getItem(AUDIO_KEY); if(raw){ const o=JSON.parse(raw); AudioStore.enabled=!!o.enabled; AudioStore.seVol=typeof o.seVol==='number'?o.seVol:0.8; AudioStore.bgmBoss=o.bgmBoss!==false; Haptics.enabled=o.haptic!==false; } }catch(e){} }
function saveAudioSettings(){ try{ localStorage.setItem(AUDIO_KEY, JSON.stringify({enabled:AudioStore.enabled,seVol:AudioStore.seVol,haptic:Haptics.enabled,bgmBoss:AudioStore.bgmBoss})); }catch(e){} }
function audioEnsure(){ if(!audioCtx){ const C=window.AudioContext||window.webkitAudioContext; if(!C) return false; audioCtx=new C(); } return true }
function audioResume(){ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }
function seInitOnUserGesture(){ if(_audioReady) return; if(!audioEnsure()) return; audioResume(); _audioReady=true; UIAudio.syncControls(); }
function now(){ return audioCtx?audioCtx.currentTime:0 }
function tone(freq=440,dur=0.06,type='square',gain=0.22){ if(!audioCtx||!AudioStore.enabled) return; const t0=now(); const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; const vol=Math.max(0,Math.min(1, AudioStore.seVol)); g.gain.value=0; g.gain.linearRampToValueAtTime(vol*gain, t0+0.005); g.gain.linearRampToValueAtTime(0, t0+dur); o.connect(g).connect(audioCtx.destination); o.start(t0); o.stop(t0+dur+0.05); }
const Sound={ play(name){ if(!_audioReady||!audioCtx||!AudioStore.enabled) return; switch(name){ case 'ui': tone(520,0.04,'square',0.18); break; case 'hit': tone(320,0.035,'square',0.18); break; case 'crit': tone(620,0.06,'triangle',0.20); setTimeout(()=>tone(840,0.05,'triangle',0.18),40); break; case 'kill': tone(560,0.05,'sine',0.20); setTimeout(()=>tone(720,0.05,'sine',0.18),50); break; case 'level': tone(500,0.08,'sine',0.18); setTimeout(()=>tone(700,0.08,'sine',0.18),90); setTimeout(()=>tone(900,0.12,'sine',0.18),180); break; case 'drop': tone(880,0.05,'triangle',0.18); setTimeout(()=>tone(1200,0.05,'triangle',0.16),40); break; case 'error': tone(200,0.12,'sawtooth',0.22); break; case 'death': tone(140,0.18,'square',0.25); setTimeout(()=>tone(90,0.22,'square',0.22),120); break; } } };
const Haptics={ enabled:true, crit:[8], death:[40,20,60], vibrate(p){ if(!this.enabled) return; if(!navigator.vibrate) return; try{ navigator.vibrate(p); }catch(e){} } };
const UIAudio={ syncControls(){ if(!ui.audioEnabled) return; ui.audioEnabled.checked=!!AudioStore.enabled; ui.hapticEnabled.checked=!!Haptics.enabled; ui.seVol.value=Math.round(AudioStore.seVol*100); ui.bgmBoss&&(ui.bgmBoss.checked=!!AudioStore.bgmBoss); } };

// 30éšãƒœã‚¹ã®ã¿BGMï¼ˆè¶…è»½é‡ã‚·ãƒ³ã‚»ï¼‰
const BGM={ g:null,timer:null,active:false,
  ensure(){ if(!audioCtx) return false; if(this.g) return true; this.g=audioCtx.createGain(); this.g.gain.value=0.08; this.g.connect(audioCtx.destination); return true },
  stop(){ if(this.timer){ clearInterval(this.timer); this.timer=null; } this.active=false; },
  playBoss(themeKey){ if(!_audioReady||!AudioStore.enabled||!AudioStore.bgmBoss) return; if(!this.ensure()) return; this.stop();
    const seq = (themeKey==='undead')? [{f:174,d:.14},{f:207,d:.10},{f:246,d:.12},{f:207,d:.10}] : [{f:220,d:.12},{f:262,d:.12},{f:330,d:.12},{f:262,d:.12}];
    let i=0; this.timer=setInterval(()=>{ const n=seq[i%seq.length]; this._note(n.f,n.d); i++; }, 420); this.active=true; },
  _note(freq,dur){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; const t0=now(); g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(0.08,t0+0.03); g.gain.linearRampToValueAtTime(0,t0+dur); o.connect(g).connect(this.g); o.start(t0); o.stop(t0+dur+0.05); }
};

/* =========================
   æ•µãƒ»ã‚¢ã‚¤ãƒ†ãƒ ãƒ—ãƒ¼ãƒ«
   ========================= */
const MONSTER_POOL=[ {name:'é‡ã†ã•ã',emoji:'ğŸ‡',tags:['plains']}, {name:'é‡ãƒã‚ºãƒŸ',emoji:'ğŸ­',tags:['plains']}, {name:'ã‚ªã‚ªã‚«ãƒŸ',emoji:'ğŸº',tags:['plains','forest']}, {name:'èœ‚ã®ç¾¤ã‚Œ',emoji:'ğŸ',tags:['plains','forest']}, {name:'ã‚«ã‚¨ãƒ«',emoji:'ğŸ¸',tags:['plains']}, {name:'å¤§ã‚¤ãƒã‚·ã‚·',emoji:'ğŸ—',tags:['plains','forest']}, {name:'å¦–ç²¾',emoji:'ğŸ§š',tags:['plains','arcane']}, {name:'ãƒˆãƒ¬ãƒ³ãƒˆã®æ',emoji:'ğŸŒ¿',tags:['plains','forest']}, {name:'ã‚´ãƒ–ãƒªãƒ³',emoji:'ğŸ‘¹',tags:['forest','cave']}, {name:'æ£®ã®ç²¾',emoji:'ğŸŒ²',tags:['forest','plains']}, {name:'å¤§ã‚³ã‚¬ãƒãƒ ã‚·',emoji:'ğŸ',tags:['forest','plains']}, {name:'ã‚¯ãƒ',emoji:'ğŸ»',tags:['forest']}, {name:'ã‚µã‚½ãƒª',emoji:'ğŸ¦‚',tags:['desert']}, {name:'ã‚³ãƒ–ãƒ©',emoji:'ğŸ',tags:['desert']}, {name:'ãƒ©ã‚¯ãƒ€ãƒã‚°',emoji:'ğŸ«',tags:['desert']}, {name:'ç ‚ã®ç²¾',emoji:'ğŸŸ¨',tags:['desert','arcane']}, {name:'ã‚¹ã‚±ãƒ«ãƒˆãƒ³',emoji:'ğŸ’€',tags:['undead','cave']}, {name:'ã‚¾ãƒ³ãƒ“',emoji:'ğŸ§Ÿ',tags:['undead']}, {name:'ã‚´ãƒ¼ã‚¹ãƒˆ',emoji:'ğŸ‘»',tags:['undead','arcane']}, {name:'ãƒŸã‚¤ãƒ©',emoji:'ğŸ§»',tags:['desert','undead']}, {name:'ã‚³ã‚¦ãƒ¢ãƒª',emoji:'ğŸ¦‡',tags:['cave','undead']}, {name:'å·¨å¤§ã‚°ãƒ¢',emoji:'ğŸ•·ï¸',tags:['cave']}, {name:'å²©ã‚´ãƒ¼ãƒ¬ãƒ ',emoji:'ğŸª¨',tags:['cave']}, {name:'ç›®ç‰',emoji:'ğŸ‘ï¸',tags:['arcane','cave']}, {name:'é­”å°æ›¸',emoji:'ğŸ“•',tags:['arcane']}, {name:'æ°´æ™¶ä½“',emoji:'ğŸ’ ',tags:['arcane','cave']}, {name:'é­”æ³•ä½¿ã„ã®æ‰‹',emoji:'ğŸ–ï¸',tags:['arcane']} ];
const BOSS_POOL=[ {name:'ã‚¨ãƒ³ãƒˆ',emoji:'ğŸŒ³',tags:['plains','forest']}, {name:'å¤§çŒªç‹',emoji:'ğŸ—',tags:['plains','forest']}, {name:'ç ‚ç«œ',emoji:'ğŸ²',tags:['desert']}, {name:'ã‚¹ãƒ•ã‚£ãƒ³ã‚¯ã‚¹',emoji:'ğŸ—¿',tags:['desert','arcane']}, {name:'ãƒªãƒƒãƒ',emoji:'ğŸª¦',tags:['undead','arcane']}, {name:'ãƒ‡ã‚¹ãƒŠã‚¤ãƒˆ',emoji:'ğŸ—¡ï¸',tags:['undead']}, {name:'ã‚±ã‚¤ãƒ–ãƒˆãƒ­ãƒ¼ãƒ«',emoji:'ğŸ‘¹',tags:['cave']}, {name:'å·¨å²©ç‹',emoji:'ğŸª¨',tags:['cave']}, {name:'ã‚¢ãƒ¼ã‚¯ãƒ¡ã‚¤ã‚¸',emoji:'ğŸ§™',tags:['arcane']}, {name:'è™šã‚ãªçœ¼',emoji:'ğŸ‘ï¸',tags:['arcane','cave']} ];
const ARCHBOSS_POOL=[ {name:'é»æ˜ã®å®ˆè­·è€…',emoji:'ğŸŒ…',tags:['plains','coast']}, {name:'æ·±ç·‘ã®ç²¾éœŠç‹',emoji:'ğŸŒ¿',tags:['forest']}, {name:'ç ‚ä¸Šã®æš´å›',emoji:'ğŸœï¸',tags:['desert']}, {name:'å†¥åºœã®ç‹',emoji:'â˜ ï¸',tags:['undead']}, {name:'åœ°åº•ã®è¦‡è€…',emoji:'â›ï¸',tags:['cave']}, {name:'ç§˜è¡“ã®å¯©å•å®˜',emoji:'ğŸ”®',tags:['arcane']} ];
const SPECIAL_POOL=[ {name:'ãƒŸãƒŸãƒƒã‚¯',emoji:'ğŸ§°', kind:'mimic', mult:1.05, goldMult:10, minRarity:'Rare'}, {name:'ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒŸãƒŸãƒƒã‚¯',emoji:'âœ¨ğŸ§°', kind:'supermimic', mult:1.20, goldMult:100, minRarity:'Epic'} ];
function poolByTheme(pool, theme){ const list=pool.filter(x=> (x.tags||[]).includes(theme)); return list.length?list:pool }

const RARITIES=[{name:'Common',weight:60,mult:1},{name:'Uncommon',weight:25,mult:1.4},{name:'Rare',weight:10,mult:2},{name:'Epic',weight:4,mult:3},{name:'Legendary',weight:1,mult:4.5}];
function weightedPick(arr){ const t=arr.reduce((s,i)=>s+i.weight,0); let r=Math.random()*t; for(const it of arr){ r-=it.weight; if(r<=0) return it; } return arr[arr.length-1] }
function cryptoId(){ const a=new Uint32Array(2); (window.crypto||window.msCrypto)?.getRandomValues?.(a); return [...a].map(x=>x.toString(16)).join('') }
function makeItem(f, minR){ const kinds=['weapon','armor','ring']; const k=choice(kinds); const rar=weightedPick(RARITIES); const order={'Common':0,'Uncommon':1,'Rare':2,'Epic':3,'Legendary':4}; let rarName=rar.name; if(minR && order[rarName]<order[minR]) rarName=minR; const mult=RARITIES.find(r=>r.name===rarName).mult; const bp=Math.max(1,Math.floor((Math.pow(f,1.12)+randInt(0,f))*0.5*mult)); const it={id:cryptoId(),name:'',slot:k,rarity:rarName,lvl:f,value:Math.max(1,Math.floor(bp*1.2))}; if(k==='weapon'){it.atk=Math.max(1,Math.floor(bp)); if(rarName!=='Common'&&Math.random()<0.35) it.crit=2+Math.floor(mult*2); it.name=`æ­¦å™¨ +${it.atk}`} else if(k==='armor'){it.hp=4*Math.max(1,Math.floor(bp*0.9)); if(rarName!=='Common'&&Math.random()<0.3) it.def=Math.floor(mult*1.2); it.name=`é§ +${it.hp}HP`} else{const r=Math.random(); if(r<0.45){it.crit=3+Math.floor(mult*2); it.name=`æŒ‡è¼ª ã‚¯ãƒª+${it.crit}%`} else if(r<0.9){it.atk=Math.max(1,Math.floor(bp*0.6)); it.name=`æŒ‡è¼ª ATK+${it.atk}`} else{it.goldB=5+Math.floor(mult*4); it.name=`æŒ‡è¼ª Gold+${it.goldB}%`}} it.name+=` (${rarName})`; return it; }
function renderItemText(it){ const p=[]; if(it.atk)p.push(`ATK+${it.atk}`); if(it.hp)p.push(`HP+${it.hp}`); if(it.def)p.push(`é˜²å¾¡+${it.def}`); if(it.crit)p.push(`ã‚¯ãƒª+${it.crit}%`); if(it.goldB)p.push(`Gold+${it.goldB}%`); const enh=(it.enhlv||0); const enhText=enh>0?` / å¼·åŒ–Lv${enh}`:''; return `${it.name}${enhText} [${p.join(', ')}]` }
function scoreItem(it){ if(!it) return -1e9; let s=0; const e=it.slot==='weapon'?effWeaponAtk(it): it.slot==='armor'?effArmorHP(it): effRing(it).atk; s+=(e)*2; s+=(it.hp??0)*0.4+(it.def??0)*2+(it.crit??0)*1.5+(it.goldB??0)*0.8; s+=(it.lvl??0)*0.2; const rar=RARITIES.find(r=>r.name===it.rarity); s*=rar?.mult??1; return s }
function tryAutoEquip(it){ const s=it.slot,cur=state.eq[s]; if(scoreItem(it)>scoreItem(cur)){ state.eq[s]=it; toast(`è£…å‚™ï¼š${renderItemText(it)}`) } }

/* =========================
   ãƒ•ãƒ­ã‚¢åï¼ˆåœ°åä½µè¨˜ï¼‰
   ========================= */
function badgeTextForFloor(){ const f=state.floor; const bi=currentBlockIdx(); const theme=ensureThemeForBlock(bi); const stage=ensureStageNameForBlock(bi, theme); const tlabel=themeLabel(theme); return `éšå±¤ ${f} ${stage} / ${tlabel}`; }

/* =========================
   éšå±¤ãƒ¡ãƒ‹ãƒ¥ãƒ¼ & å…¥åŠ›
   ========================= */
// ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜åˆ°é”ã‚’å‚ç…§ã—ã¦ç§»å‹•ã‚’åˆ¶é™
function canGoNext(){ const dead=state.monster && state.monster.hp<=0; const canUpByRound=state.floor<state.roundMaxFloor; return dead||canUpByRound }
function refreshFloorHints(){ const bi=currentBlockIdx(); const theme=ensureThemeForBlock(bi); const stage=ensureStageNameForBlock(bi,theme); const msg=`ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜ï¼š${state.roundMaxFloor} éš / é€šç®—æœ€é«˜ï¼š${state.bestMaxFloor} / ãƒ†ãƒ¼ãƒï¼š${themeLabel(theme)} / ã‚¹ãƒ†ãƒ¼ã‚¸ï¼š${stage}`; if(ui.fmHint) ui.fmHint.textContent=msg; if(ui.fmNext) ui.fmNext.disabled=!canGoNext(); if(ui.fmPrev) ui.fmPrev.disabled=state.floor<=1; if(ui.fmStay) ui.fmStay.checked=!!state.stay; }
function toggleFloorMenu(show){ if(!ui.floorMenu) return; ui.floorMenu.hidden=(show===undefined)?!ui.floorMenu.hidden:!show; if(!ui.floorMenu.hidden){ Sound.play('ui'); refreshFloorHints(); } }
// ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼é ˜åŸŸã®æ”»æ’ƒæ‹¾ã„ã‚’æ­¢ã‚ã‚‹ãƒ˜ãƒ«ãƒ‘ï¼ˆéšå±¤ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ï¼‰
function stopAttackIn(el){ if(!el) return; ['pointerdown','click','touchstart','mousedown'].forEach(ev=>{ el.addEventListener(ev, e=>{ e.stopPropagation(); }, {passive:false}); }); }

/* =========================
   å…¥åŠ›ãƒã‚¤ãƒ³ãƒ‰
   ========================= */
let _holding=false,_t=0,_saw=false;
function onPD(e){ e.preventDefault(); _saw=true; _t=Date.now(); if(_holding) return; _holding=true; attack(); }
function onPU(){ _holding=false }
function bindInput(el){ if(!el) return; if(window.PointerEvent){ on(el,'pointerdown',onPD,{passive:false}); on(el,'pointerup',onPU); on(el,'pointercancel',onPU); on(el,'pointerleave',onPU); } else { on(el,'click',()=>{ if(_saw && Date.now()-_t<200) return; attack(); }); } }
// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚„å…¥åŠ›æ¬„ã¯æ”»æ’ƒç„¡åŠ¹åŒ–
stopAttackIn(document.getElementById('floorMenu'));
stopAttackIn(document.getElementById('floorMenuBtn'));
stopAttackIn(document.getElementById('fmJumpInput'));

/* =========================
   å‡ºç¾ / æˆ¦é—˜ / å ±é…¬
   ========================= */
function spawnMonster(){
  const f=state.floor; const isArch=(f%30===0); const isBoss10=(!isArch && f%10===0);
  const bi=currentBlockIdx(); const theme=ensureThemeForBlock(bi);
  applyThemeSkin(theme);
  refreshFloorHints();

  let base=null,type='normal';
  if(isArch){ base=choice(poolByTheme(ARCHBOSS_POOL,theme)); type='archboss'; }
  else if(isBoss10){ base=choice(poolByTheme(BOSS_POOL,theme)); type='boss'; }
  else { const r=Math.random(); if(r<0.012){ base=SPECIAL_POOL[1]; type='supermimic'; } else if(r<0.042){ base=SPECIAL_POOL[0]; type='mimic'; } else { base=choice(poolByTheme(MONSTER_POOL,theme)); } }

  const hp0=eHP(f,isBoss10||isArch), gold0=eGold(f,isBoss10||isArch), atk0=eATK(f,isBoss10||isArch);
  let hp=hp0, gold=gold0, atk=atk0;
  if(type==='archboss'){ hp=Math.floor(hp0*3.0); gold=Math.floor(gold0*2.2); atk=Math.floor(atk0*1.6);}
  else if(type==='boss'){ hp=Math.floor(hp0*1.2); gold=Math.floor(gold0*1.1); atk=Math.floor(atk0*1.1);}

  state.monster={name:`Lv${f} ${base.name}`,emoji:base.emoji,hp,maxHP:hp,gold,atk,isBoss:(type==='boss'||type==='archboss'),type};
  state.engaged=false; state.isDown=false; state.reviveAt=0; state.bossEndsAt=0;

  if(ui.monsterFace) ui.monsterFace.textContent=base.emoji;
  if(ui.monsterName) ui.monsterName.textContent=state.monster.name;
  if(ui.monsterHPText) ui.monsterHPText.textContent=`${hp} / ${hp}`;
  if(ui.monsterHP) ui.monsterHP.style.width='100%';
  if(ui.floorBadge) ui.floorBadge.innerHTML = `${badgeTextForFloor()} <span class="theme-badge" id="themeBadge">${themeLabel(theme)}</span>`;
  ui.themeBadge=document.getElementById('themeBadge');
  updateAttackBtn();

  // 30éšãƒœã‚¹ã®ã¿BGM
  if(type==='archboss' && _audioReady && AudioStore.bgmBoss){ BGM.playBoss(theme); } else { BGM.stop(); }
}

function applyDrop(){
  const luck=(ringEff().goldB||0)*0.2; const drop=0.20+luck/100;
  if(Math.random()<drop){ const it=makeItem(state.floor); state.inv.push(it); if(state.autoEquip) tryAutoEquip(it); Sound.play('drop'); return {item:it}; }
  return {item:null};
}

function awardOneKillAndGetGains(m){
  const goldMult=(m.type==='mimic')?10:(m.type==='supermimic')?100:1;
  const expBase=Math.max(1,Math.floor(3+state.floor*0.6));
  const expGain=expBase*goldMult;
  const goldGain=Math.floor(m.gold*goldMult*(1+goldB()/100));
  state.gold+=goldGain; state.kills+=1; state.exp+=expGain;

  let items=0; const d=applyDrop(); if(d.item) items+=1;

  while(state.exp>=state.expToNext){
    state.exp-=state.expToNext; state.level+=1; state.expToNext=Math.floor(state.expToNext*1.25+8);
    state.baseATK+=1; state.baseHP+=2; state.playerHP=recalcMaxHP();
    toast('ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ATK+1 / HP+2'); Sound.play('level');
  }
  // ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜ / é€šç®—æœ€é«˜ æ›´æ–°
  if(state.floor>state.roundMaxFloor) state.roundMaxFloor=state.floor;
  if(state.roundMaxFloor>state.bestMaxFloor) state.bestMaxFloor=state.roundMaxFloor;

  return {g:goldGain,e:expGain,i:items};
}

function doKillAdvanceAndMaybeStay(){ if(state.stay){ spawnMonster(); } else { state.floor+=1; spawnMonster(); } }

/* ===== GMåå¿œï¼ˆè¤‡æ•°éšå±¤è¸ç ´ã®æ®µéšåŒ–ï¼‰ ===== */
const GM_TIERS=[
  {min:2, max:2, lines: delta=>[
    `GMï¼šã‚“ï¼Ÿâ€¦ä»Šã€${state.username||'å›'}ã®åã‚’è¦‹ãŸæ°—ãŒã™ã‚‹ã€‚`,
    `GMï¼šæ°—ã®ã›ã„ã‹â€¦${delta}æ®µã€è»½ãè·³ã‚“ã ï¼Ÿ`,
  ]},
  {min:3, max:5, lines: ()=>[
    'GMï¼šã„ã„ã­ã€ãã®å‹¢ã„ã ã€‚',
    'GMï¼šæ‰‹æ…£ã‚Œã¦ããŸãªã€‚'
  ]},
  {min:6, max:10, lines: ()=>[
    'GMï¼šã‚„ã‚‹ã­ã€‚ã“ã“ã‹ã‚‰ãŒé¢ç™½ã„ã€‚', 'GMï¼šãã®èª¿å­ã€ã¾ã ä¸ŠãŒã‚‹ã€‚'
  ]},
  {min:11, max:20, lines: ()=>[
    'GMï¼šæ³¨ç›®ã€‚æµã‚Œã‚’æ´ã‚“ã ã‹ï¼Ÿ', 'GMï¼šè¦‹ã›å ´ã ã€‚'
  ]},
  {min:21, max:30, lines: ()=>[
    'GMï¼šè³è³›ã—ã‚ˆã†ã€‚è¦‹äº‹ã ã€‚', 'GMï¼šæ€ã£ãŸã‚ˆã‚Šã€ãšã£ã¨é€Ÿã„ã€‚'
  ]},
  {min:31, max:50, lines: ()=>[
    'GMï¼šå–é‡‡ã€‚æ­¢ã¾ã‚‰ãªã„ãªã€‚', 'GMï¼šè¦³å®¢ãŒã„ãŸã‚‰ç«‹ã¡ä¸ŠãŒã£ã¦ã‚‹ã€‚'
  ]},
  {min:51, max:80, lines: ()=>[
    'GMï¼šé©šãã ã€‚äºˆå®šã‚’æ›´æ–°ã™ã‚‹ã€‚', 'GMï¼šæƒ³å®šã‚’é£›ã³è¶ŠãˆãŸãªã€‚'
  ]},
  {min:81, max:120, lines: ()=>[
    'GMï¼šæˆ¦æ…„â€¦ã“ã‚Œã¯è¨­è¨ˆã®å¤–å´ã ã€‚', 'GMï¼šå†·ãŸã„æ±—ãŒå‡ºãŸã‚ˆã€‚'
  ]},
  {min:121, max:200, lines: ()=>[
    'GMï¼šææ€–ã€ã¨ã„ã†ã‚„ã¤ã‹ã‚‚ã—ã‚Œãªã„ã€‚', 'GMï¼šã“ã“ã¾ã§æ¥ã‚‹ã‹â€¦ã€‚'
  ]},
  {min:201, max:99999, lines: ()=>[
    'GMï¼šå‘†ã‚Œã‚‹ã»ã©ã ã€‚', 'GMï¼šãƒ‰ãƒ³å¼•ãã€‚ã‚„ã‚Šè¾¼ã¿ã™ãã§ã—ã‚‡ã€‚'
  ]}
];
function gmReactForDelta(delta){
  for(const t of GM_TIERS){ if(delta>=t.min && delta<=t.max){ const arr=t.lines(delta); return choice(arr); } }
  return null;
}
function stepMessageForDelta(delta){
  if(delta<1) return null;
  if(delta===1) return `+1éšå±¤ è¸ç ´ï¼`;
  if(delta<=3) return `${delta}éšå±¤ è¸ç ´ã—ãŸï¼`;
  if(delta<=5) return `${delta}éšå±¤ èµ°ã‚ŠæŠœã‘ãŸï¼`;
  if(delta<=10) return `${delta}éšå±¤ã‚’ä¸€æ°—ã«çªç ´ï¼`;
  if(delta<=20) return `${delta}éšå±¤ã‚’è–™ãæ‰•ã£ãŸï¼`;
  if(delta<=50) return `${delta}éšå±¤ã‚’ç²‰ç •ã—ãŸï¼`;
  return `${delta}éšå±¤ã‚’ç ´å£Šã—ãŸâ€¦ï¼`;
}

/* ===== ãƒ¡ã‚¤ãƒ³æ”»æ’ƒ ===== */
function updateAttackBtn(){ const m=state.monster; if(!m||!ui.attackBtn) return; const expected=playerATK(); if(!state.engaged){ ui.attackBtn.textContent=(expected>=m.hp)?'å€’ã™':'æˆ¦é—˜é–‹å§‹ï¼'; return } ui.attackBtn.textContent=(expected>=m.hp)?'å€’ã™':'æ”»æ’ƒï¼ˆã‚¿ãƒƒãƒ—ï¼‰'; }

function attack(){
  if(!state.monster) return;
  if(state.playerHP<=0){ toast('â€¦'); return; }
  beginEngage();

  const startFloorBefore=state.floor;

  const m=state.monster; if(m.hp<=0) return;
  const {dmg,isCrit}=clickDamage(); let dealt=Math.min(m.hp,dmg);
  m.hp-=dealt;
  if(ui.monsterHP) ui.monsterHP.style.width=`${(m.hp/m.maxHP)*100}%`;
  if(ui.monsterHPText) ui.monsterHPText.textContent=`${m.hp} / ${m.maxHP}`;
  if(isCrit){ pushLog(`<span class=\"log-num-orange\">${dealt}</span>ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ <span class=\"log-crit-red\">ã€Œã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼ã€</span>`); Sound.play('crit'); Haptics.vibrate(Haptics.crit); }
  else { pushLog(`<span class=\"log-num-yellow\">${dealt}</span>ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`); Sound.play('hit'); }

  if(m.hp<=0){
    // 1ä½“ç›®
    const monName=m.name; let agg=awardOneKillAndGetGains(m);
    let kills=1, totalG=agg.g, totalE=agg.e, totalI=agg.i;
    showKillFlavor(killFlavorText(monName)); Sound.play('kill');

    // ä½™å‰°ã§é€£é–
    let leftover=dmg - dealt;
    if(state.relicActive.kashiwa && leftover>0){
      let safety=60;
      while(leftover>0 && safety-->0){
        doKillAdvanceAndMaybeStay();
        const m2=state.monster; if(!m2) break; const hp2=m2.hp;
        if(leftover>=hp2){
          leftover-=hp2; agg=awardOneKillAndGetGains(m2);
          kills++; totalG+=agg.g; totalE+=agg.e; totalI+=agg.i; Sound.play('kill');
        } else {
          m2.hp=Math.max(1,hp2-leftover); leftover=0;
          if(ui.monsterHP) ui.monsterHP.style.width=`${(m2.hp/m2.maxHP)*100}%`;
          if(ui.monsterHPText) ui.monsterHPText.textContent=`${m2.hp} / ${m2.maxHP}`;
          break;
        }
      }
    } else {
      doKillAdvanceAndMaybeStay();
    }

    // ã¾ã¨ã‚ãƒ­ã‚°
    const deltaFloors = state.stay ? 0 : Math.max(0, state.floor - startFloorBefore);
    if(kills>=2){
      const gm = gmReactForDelta(deltaFloors);
      if(gm) pushLog(`<b>${gm}</b>`);
      pushLog(`ã¾ã¨ã‚ã¦ <b>${kills}</b> ä½“è¨ä¼ï¼ åˆè¨ˆ <span class='gold'>+${totalG}G</span> / <b>+${totalE}EXP</b> / è£…å‚™ <b>${totalI}</b> ä»¶`);
    }
    // è¤‡æ•°éšå±¤è¸ç ´ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if(deltaFloors>=1){ const s = stepMessageForDelta(deltaFloors); if(s) pushLog(`<b>${s}</b>`); }

    updateUI(); refreshFloorHints();
  }
  updateAttackBtn();
}

function enemyTick(dt){
  if(!state.monster||!state.engaged||state.isDown)return;
  const m=state.monster; if(m.hp<=0)return;
  const dps=Math.max(0,m.atk-playerDEF()*0.6);
  const dmg=dps*dt; if(dmg<=0)return;
  state.playerHP-=dmg;
  if(state.playerHP<=0&&!state.isDown){
    state.playerHP=0; state.isDown=true; state.deaths+=1; state.reviveAt=Date.now()+5000;
    toast(`æ°—çµ¶ã—ã¾ã—ãŸâ€¦${5}ç§’å¾Œã«å¾©æ´»`); Sound.play('death'); Haptics.vibrate(Haptics.death);
  }
}
function regenTick(dt){ if(state.playerHP>0){ const mx=recalcMaxHP(); state.playerHP=clamp(state.playerHP+dt*(0.8+state.level*0.02),0,mx); } }
function autoTapTick(dt){ if(state.autoTap<=0||!state.engaged||state.isDown) return; autoTapTick._acc=(autoTapTick._acc||0)+state.autoTap*dt; while(autoTapTick._acc>=1){ autoTapTick._acc-=1; attack(); } }
function timersTick(){
  let txt=[];
  if(state.reviveAt>0){
    const left=Math.max(0,state.reviveAt-Date.now()); txt.push(`${Math.ceil(left/1000)}s`);
    if(left<=0){ state.reviveAt=0; state.playerHP=recalcMaxHP(); state.isDown=false; state.engaged=false; toast('å¾©æ´»ï¼'); updateAttackBtn(); }
  }
  if(ui.timerAll) ui.timerAll.textContent=txt.join(' / ');
  updateFlavorBar();
}

<!-- ===== Part 3 / 3 : JSï¼ˆçµç·šãƒ»ä¿å­˜ãƒ»UIæ›´æ–°ãªã©ï¼‰ ===== -->

/* ---------------------------
   ã‚¹ãƒ†ãƒ¼ã‚¸åã¨ãƒ†ãƒ¼ãƒè¡¨ç¤ºã®è£œåŠ©
---------------------------- */
function badgeTextForFloor(){
  const bi=currentBlockIdx();
  const theme=ensureThemeForBlock(bi);
  const stage=ensureStageNameForBlock(bi,theme); // ä¾‹ï¼šã‚¢ã‚ºãƒã®æ£®
  return `éšå±¤ ${state.floor} <span class="theme-badge" id="themeBadge">${stage}</span>`;
}

/* ---------------------------
   é›£æ˜“åº¦ã®å¾®å¢—ï¼ˆ30n+1ä»¥é™ï¼‰
   ãƒ–ãƒ­ãƒƒã‚¯ãŒé€²ã‚€ã»ã© â€œå°‘ã—ã ã‘â€ æ•µHP/ATKã‚’ä¸Šä¹—ã›
---------------------------- */
function blockDiffMult(){
  const blk = Math.max(0, Math.floor((state.floor-1)/30)); // 0:1-30, 1:31-60, ...
  const STEP = 0.03; // 1ãƒ–ãƒ­ãƒƒã‚¯ã”ã¨ã« +3%
  return 1 + blk*STEP;
}

/* ---------------------------
   ã¾ã¨ã‚è¸ç ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ & GMåå¿œã‚¹ã‚±ãƒ¼ãƒ«
---------------------------- */
const STRIDE_MSG = [
  {min:2, max:2,  pool:(n)=>[`ä¸€æ°—ã« <b>${n}</b> éšå±¤è¸ç ´ã—ãŸï¼`]},
  {min:3, max:5,  pool:(n)=>[`<b>${n}</b> éšå±¤ã‚’é§†ã‘æŠœã‘ãŸï¼`,`<b>${n}</b> éšå±¤ã‚’é€£ç¶šçªç ´ï¼`]},
  {min:6, max:10, pool:(n)=>[`<b>${n}</b> éšå±¤ã‚’èµ°ã‚ŠæŠœã‘ãŸï¼`,`<b>${n}</b> éšå±¤ã‚’ç²‰ç •ï¼`]},
  {min:11,max:20, pool:(n)=>[`<b>${n}</b> éšå±¤ã‚’æ’ƒç ´ã—ç¶šã‘ã¦ã„ã‚‹â€¦`,`æ­¢ã¾ã‚‰ãªã„â€¦ <b>${n}</b> å±¤çªç ´ï¼`]},
  {min:21,max:40, pool:(n)=>[`<b>${n}</b> éšå±¤ã‚’è¹‚èº™ï¼`,`<b>${n}</b> éšå±¤ã‚’é¢¨ã®ã‚ˆã†ã«é€šéï¼`]},
  {min:41,max:80, pool:(n)=>[`<b>${n}</b> å±¤ã®å£ãŒæ„å‘³ã‚’æˆã•ãªã„â€¦`,`ãŸã ã®ç›´ç·šã ã€<b>${n}</b> éšå±¤ã ï¼`]},
  {min:81,max:160,pool:(n)=>[`ä¸–ç•ŒãŒè»‹ã‚€ã€‚<b>${n}</b> å±¤ãŒå´©ã‚Œè½ã¡ãŸã€‚`,`<b>${n}</b> å±¤ã‚’ä¸€æ¯ã§æº¶ã‹ã—ãŸï¼`]},
  {min:161,max:999999,pool:(n)=>[`è¨˜éŒ²çš„ã ã€‚<b>${n}</b> å±¤ã‚’ç ´å£Šã—ãŸâ€¦`,`åœ°å¹³ãŒå¡—ã‚Šæ›¿ã‚ã‚‹ã€‚<b>${n}</b> å±¤å£Šæ»…ï¼`]},
];
function pickStrideMsg(n){
  const tier = STRIDE_MSG.find(t=>n>=t.min && n<=t.max) || STRIDE_MSG[STRIDE_MSG.length-1];
  const arr = tier.pool(n);
  return arr[Math.floor(Math.random()*arr.length)];
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åå…¥ã‚Šã®GMåå¿œï¼ˆæ®µéšåŒ–ï¼‰
function gmReactScaled(stride){
  const name = (state.username||'æ—…äºº');
  const p2 = [
    `GMï¼šâ€¦ã‚ã‚Œã€${name}ï¼Ÿ ã„ã¾ä½•ã‹ã—ãŸï¼Ÿ`,
    `GMï¼šãµã‚€ã€${name}ãŒå°‘ã—é€Ÿã„ã€‚`,
  ];
  const p3_5 = [
    `GMï¼šã„ã„ã­ã€${name}ã€‚`,
    `GMï¼šãã®èª¿å­ã ã€${name}ã€‚`,
    `GMï¼šè¦‹ãˆã¦ããŸã­ã€${name}ã€‚`
  ];
  const p6_10 = [
    `GMï¼šã‚„ã‚‹ã­ã€‚`,
    `GMï¼šæ­¢ã¾ã‚‰ãªã„ã€‚`,
    `GMï¼šé¢ç™½ããªã£ã¦ããŸã€‚`
  ];
  const p11_20 = [
    `GMï¼šæ³¨ç›®ã—ã‚ˆã†ã€‚`,
    `GMï¼šãã‚ãã‚æ‰‹ã‚’å©ã“ã†ã‹ã€‚`
  ];
  const p21_40 = [
    `GMï¼šè³è³›ã—ã‚ˆã†ã€‚`,
    `GMï¼šå–é‡‡ã ï¼`
  ];
  const p41_80 = [
    `GMï¼šé©šã„ãŸã‚ˆã€‚`,
    `GMï¼šæƒ³å®šå¤–ã ã€‚`
  ];
  const p81_160 = [
    `GMï¼šæˆ¦æ…„ã™ã‚‹ã­â€¦`,
    `GMï¼šã“ã“ã¾ã§ã‚„ã‚‹ã¨ã¯ã€‚`
  ];
  const p161_320 = [
    `GMï¼šææ€–ã™ã‚‰è¦šãˆã‚‹ã€‚`,
    `GMï¼šã‚‚ã†ç¬‘ã†ã—ã‹ãªã„ã­ã€‚`
  ];
  const p321plus = [
    `GMï¼šå‘†ã‚Œã‚‹ã»ã©ã®ã‚„ã‚Šè¾¼ã¿ã€‚`,
    `GMï¼šãƒ‰ãƒ³å¼•ãã ã‚ˆï¼Ÿï¼ˆè¤’ã‚ã¦ã‚‹ï¼‰`,
    `GMï¼šã‚‚ã†å›ãŒGMã§ã„ã„ã®ã§ã¯ã€‚`
  ];
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  if(stride<=1) return null;
  if(stride===2) return pick(p2);
  if(stride<=5)  return pick(p3_5);
  if(stride<=10) return pick(p6_10);
  if(stride<=20) return pick(p11_20);
  if(stride<=40) return pick(p21_40);
  if(stride<=80) return pick(p41_80);
  if(stride<=160) return pick(p81_160);
  if(stride<=320) return pick(p161_320);
  return pick(p321plus);
}

/* ---------------------------
   æ‰€æŒï¼†è£…å‚™UI
---------------------------- */
function rarityCls(r){return `rarity-${(r||'Common')}`}
function renderEquipped(){
  const w=state.eq.weapon,a=state.eq.armor,r=state.eq.ring;
  const nm=(it)=>it?`${it.name}`:'ãªã—';
  ui.fmWeapon&&(ui.fmWeapon.textContent=nm(w));
  ui.fmArmor&&(ui.fmArmor.textContent=nm(a));
  ui.fmRing&&(ui.fmRing.textContent=nm(r));
  refreshEnhUI(); renderUniqueList();
}
function renderInventory(){
  const box=ui.invList; if(!box) return; box.innerHTML='';
  ui.bagEq&&(ui.bagEq.textContent=state.inv.length);
  for(const it of state.inv){
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`<div><b>${it.name}</b></div><div class='small'>${renderItemText(it)}</div>`;
    box.appendChild(div);
  }
  refreshBulkNote();
}
function openChooser(slot){
  const list=state.inv.filter(it=>it.slot===slot);
  ui.chooserTitle&&(ui.chooserTitle.textContent=slot==='weapon'?'æ­¦å™¨ã‚’é¸æŠ':slot==='armor'?'é§ã‚’é¸æŠ':'è£…é£¾å“ã‚’é¸æŠ');
  const box=ui.chooserList; if(!box) return; box.innerHTML='';
  if(list.length===0){
    const p=document.createElement('div'); p.className='small'; p.textContent='è©²å½“è£…å‚™ãªã—'; box.appendChild(p);
  } else {
    list.forEach(it=>{
      const b=document.createElement('button'); b.className='btn'; b.textContent=renderItemText(it); b.style.textAlign='left';
      b.onclick=()=>{ state.eq[slot]=it; toast(`è£…å‚™ï¼š${renderItemText(it)}`); ui.chooserCard.hidden=true; updateUI(); };
      box.appendChild(b);
    });
  }
  ui.chooserCard.hidden=false;
}
$$('#tab-inv [data-change]').forEach(btn=>on(btn,'click',()=>openChooser(btn.getAttribute('data-change'))));
$$('#tab-inv [data-unequip]').forEach(btn=>on(btn,'click',()=>{ const slot=btn.getAttribute('data-unequip'); state.eq[slot]=null; updateUI(); }));

/* è£…å‚™å¼·åŒ–UI */
function enhCost(it, slot){ const lv=it?.enhlv||0; if(slot==='weapon') return 2+lv*2; if(slot==='armor') return 1+lv; return 3+lv; }
function refreshEnhUI(){
  const w=state.eq.weapon,a=state.eq.armor,r=state.eq.ring;
  // weapon
  if(ui.enhWInfo){
    if(!w){ ui.enhWInfo.textContent='æ­¦å™¨æœªè£…å‚™'; ui.enhWBtn&&(ui.enhWBtn.disabled=true); }
    else{
      const lv=w.enhlv||0; const cost=enhCost(w,'weapon');
      ui.enhWInfo.innerHTML=`${renderItemText(w)} ï¼ æ¬¡ATKï¼š<b>${effWeaponAtk({...w,enhlv:lv+1})}</b>`;
      ui.enhWCost&&(ui.enhWCost.textContent=cost);
      ui.enhWBtn&&(ui.enhWBtn.disabled=state.pebbles<cost);
      ui.enhWBtn&&(ui.enhWBtn.onclick=()=>{ if(state.pebbles<cost){ Sound.play('error'); return } w.enhlv=lv+1; state.pebbles-=cost; toast('æ­¦å™¨ã‚’å¼·åŒ–ï¼'); updateUI(); });
    }
  }
  // armor
  if(ui.enhAInfo){
    if(!a){ ui.enhAInfo.textContent='é§æœªè£…å‚™'; ui.enhABtn&&(ui.enhABtn.disabled=true); }
    else{
      const lv=a.enhlv||0; const cost=enhCost(a,'armor');
      ui.enhAInfo.innerHTML=`${renderItemText(a)} ï¼ æ¬¡HPï¼š<b>${effArmorHP({...a,enhlv:lv+1})}</b>`;
      ui.enhACost&&(ui.enhACost.textContent=cost);
      ui.enhABtn&&(ui.enhABtn.disabled=state.pebbles<cost);
      ui.enhABtn&&(ui.enhABtn.onclick=()=>{ if(state.pebbles<cost){ Sound.play('error'); return } a.enhlv=lv+1; state.pebbles-=cost; toast('é§ã‚’å¼·åŒ–ï¼'); updateUI(); });
    }
  }
  // ring
  if(ui.enhRInfo){
    if(!r){ ui.enhRInfo.textContent='è£…é£¾å“æœªè£…å‚™'; ui.enhRBtn&&(ui.enhRBtn.disabled=true); }
    else{
      const lv=r.enhlv||0; const cost=enhCost(r,'ring'); const next=effRing({...r,enhlv:lv+1});
      ui.enhRInfo.innerHTML=`${renderItemText(r)} ï¼ æ¬¡ï¼šATK <b>${next.atk||0}</b> / ã‚¯ãƒª <b>${next.crit||0}</b>% / Gold <b>${next.goldB||0}</b>%`;
      ui.enhRCost&&(ui.enhRCost.textContent=cost);
      ui.enhRBtn&&(ui.enhRBtn.disabled=state.pebbles<cost);
      ui.enhRBtn&&(ui.enhRBtn.onclick=()=>{ if(state.pebbles<cost){ Sound.play('error'); return } r.enhlv=lv+1; state.pebbles-=cost; toast('è£…é£¾å“ã‚’å¼·åŒ–ï¼'); updateUI(); });
    }
  }
}

/* ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼†ç¥å™¨éŒ¬æˆ */
function renderUniqueList(){
  if(!ui.uniqListBox) return;
  ensureUniqueSwordItem();
  const eff=uniqueSwordATK();
  const mult=(1+state.bestMaxFloor*0.01).toFixed(2);
  ui.uniqListBox.innerHTML = `<div class='small'>ãƒ»${uniqueSwordName()} â€” å®ŸåŠ¹ATK <b>${eff}</b>ï¼ˆåŸºç¤ATK <b>${state.uniqueWeapon.base}</b> Ã— å¤šå€ç‡ <b>${mult}</b>ï¼‰</div>`;
  ui.relicSwordInfo&&(ui.relicSwordInfo.innerHTML=ui.uniqListBox.innerHTML);
}
function demonGainForItem(it){
  if(!it||it.id==='unique_demon'||it.persist) return 0;
  if(it.slot==='weapon'){ return Math.floor((it.atk||1)*0.6); }
  if(it.slot==='armor'){ return Math.floor((it.hp||0)*0.1) + Math.floor((it.def||0)*3); }
  if(it.slot==='ring'){  return Math.floor((it.atk||0)*0.4) + Math.floor((it.crit||0)*1) + Math.floor((it.goldB||0)*0.2); }
  return 0;
}
function refreshDemonList(){
  const list=state.inv.filter(it=>it.slot==='weapon' && it.id!=='unique_demon');
  const box=ui.demonList; if(!box) return; box.innerHTML='';
  if(list.length===0){
    const p=document.createElement('div'); p.className='small'; p.textContent='æ§ã’ã‚‰ã‚Œã‚‹æ­¦å™¨ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå€‹åˆ¥ï¼‰'; box.appendChild(p);
  } else {
    list.forEach(it=>{
      const row=document.createElement('div'); row.className='row';
      row.innerHTML=`<div class='small'>${renderItemText(it)}</div>`;
      const b=document.createElement('button'); b.className='btn';
      const gain=Math.floor((it.atk||1)*0.6); b.textContent=`å€‹åˆ¥éŒ¬æˆ (+${gain} åŸºç¤ATK)`;
      b.onclick=()=>{ state.uniqueWeapon.base+=gain; state.uniqueWeapon.feeds+=1; state.inv=state.inv.filter(x=>x!==it); ensureUniqueSwordItem(); toast(`ç¥å™¨ãŒåŠ›ã‚’å¾—ãŸï¼ +${gain} åŸºç¤ATK`); updateUI(); };
      row.appendChild(b); box.appendChild(row);
    });
  }
}
function refreshBulkNote(){
  if(!ui.bulkCount||!ui.bulkForgeNote) return;
  const ids=new Set(); const pool=[];
  ['weapon','armor','ring'].forEach(s=>{ const it=state.eq[s]; if(it && !it.persist && it.id!=='unique_demon'){ ids.add(it.id); pool.push(it); } });
  state.inv.forEach(it=>{ if(!it.persist && it.id!=='unique_demon' && !ids.has(it.id)){ pool.push(it); ids.add(it.id); } });
  ui.bulkCount.textContent=pool.length;
}
function doBulkForge(){
  const ids=new Set(); const pool=[];
  ['weapon','armor','ring'].forEach(s=>{ const it=state.eq[s]; if(it && !it.persist && it.id!=='unique_demon'){ ids.add(it.id); pool.push(it); }});
  state.inv.forEach(it=>{ if(!it.persist && it.id!=='unique_demon' && !ids.has(it.id)){ pool.push(it); ids.add(it.id); }});
  const cnt=pool.length; if(cnt<=0){ toast('éŒ¬æˆã§ãã‚‹è£…å‚™ãŒã‚ã‚Šã¾ã›ã‚“'); return }
  if(!confirm(`ä¸€æ‹¬éŒ¬æˆã—ã¾ã™ã€‚è£…å‚™ä¸­ã‚’å«ã‚€ã€ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ä»¥ä¸‹ã€ã®è£…å‚™ã‚’å…¨ã¦æ¶ˆè²»ã—ã¾ã™ã€‚\nä»¶æ•°ï¼š${cnt}\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  let gain=0; pool.forEach(it=>{ gain+=demonGainForItem(it); });
  state.uniqueWeapon.base+=gain; state.uniqueWeapon.feeds+=cnt;
  state.inv=state.inv.filter(it=>!ids.has(it.id));
  ['weapon','armor','ring'].forEach(s=>{ const it=state.eq[s]; if(it && ids.has(it.id)) state.eq[s]=null; });
  ensureUniqueSwordItem(); toast(`ä¸€æ‹¬éŒ¬æˆï¼š+${gain} åŸºç¤ATKï¼ˆ${cnt}ä»¶ï¼‰`); updateUI();
}
on(ui.bulkForgeBtn,'click',()=>doBulkForge());

/* ---------------------------
   å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰æ¶ˆè²»ï¼‰
---------------------------- */
function tryBuy(costKey, applyFn){
  const price=prices[costKey];
  if(state.gold<price){ toast('GãŒè¶³ã‚Šãªã„'); Sound.play('error'); return false }
  state.gold-=price;
  prices[costKey]=Math.ceil(price*1.18+1);
  applyFn(); updateUI(); save(false); return true;
}
on(ui.buyAtk,'click',()=>tryBuy('atk',()=>{ state.upg.atk++; state.baseATK++; toast('ATK +1'); }));
on(ui.buyHP,'click',()=>tryBuy('hp',()=>{ state.upg.hp++; state.baseHP+=5; state.playerHP=recalcMaxHP(); toast('æœ€å¤§HP +5'); }));
on(ui.buyAuto,'click',()=>tryBuy('auto',()=>{ state.upg.auto++; state.autoTap=(state.autoTap||0)+0.2; toast('è‡ªå‹•ã‚¿ãƒƒãƒ— +0.2/s'); }));
$$('#tab-upg .btn.mini').forEach(btn=>on(btn,'click',()=>{
  const [key,mode]=(btn.getAttribute('data-bulk')||'atk-1').split('-');
  let n=mode==='10'?10:mode==='100'?100:mode==='max'?1e6:1;
  for(let i=0;i<n;i++){
    const ok= key==='atk'? tryBuy('atk',()=>{state.upg.atk++; state.baseATK++;})
             : key==='hp'?  tryBuy('hp', ()=>{state.upg.hp++; state.baseHP+=5; state.playerHP=recalcMaxHP();})
                         : tryBuy('auto',()=>{state.upg.auto++; state.autoTap=(state.autoTap||0)+0.2;});
    if(!ok) break;
  }
}));

/* ---------------------------
   ãƒ•ãƒƒã‚¿ãƒ¼ãƒ»ã‚¿ãƒ–åˆ‡æ›¿
---------------------------- */
const fTabs=$$('#mainFooter .ftab');
function switchMainTab(tabId){
  [ui.tabUpg,ui.tabInv,ui.tabSta,ui.tabAdv,ui.tabSettings].forEach(el=>el&&el.setAttribute('hidden',''));
  const el=document.getElementById(tabId); if(el) el.removeAttribute('hidden');
  fTabs.forEach(btn=>btn.classList.toggle('active', btn.getAttribute('data-tab')===tabId));
  Sound.play('ui');
}
fTabs.forEach(btn=>on(btn,'click',()=>switchMainTab(btn.getAttribute('data-tab'))));
ui.eqTabs.forEach(btn=>on(btn,'click',()=>{ ui.eqTabs.forEach(x=>x.classList.remove('active')); btn.classList.add('active'); const id=btn.getAttribute('data-eqtab'); ui.eqManage.setAttribute('hidden',''); ui.eqEnhance.setAttribute('hidden',''); document.getElementById(id)?.removeAttribute('hidden'); Sound.play('ui'); }));
ui.uniqTabs.forEach(btn=>on(btn,'click',()=>{ ui.uniqTabs.forEach(x=>x.classList.remove('active')); btn.classList.add('active'); const id=btn.getAttribute('data-uniqtab'); ui.uniqList.setAttribute('hidden',''); ui.uniqForge.setAttribute('hidden',''); document.getElementById(id)?.removeAttribute('hidden'); Sound.play('ui'); }));

/* ---------------------------
   éšå±¤ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚¿ãƒƒãƒ—æ”»æ’ƒç„¡åŠ¹ ï¼ æ•°å€¤å…¥åŠ›å¯¾ç­–ï¼‰
---------------------------- */
function stopTap(e){ e.stopPropagation(); _holding=false; }
on(ui.floorMenuBtn,'pointerdown',stopTap);
on(ui.floorMenu,'pointerdown',stopTap);
['click','pointerup','pointerdown','touchstart','touchend'].forEach(ev=>{
  on(ui.floorMenu,ev,stopTap); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã§ã¯æ”»æ’ƒã—ãªã„
});
function canGoNext(){ // â˜…ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜ã‚’å‚ç…§
  const dead=state.monster && state.monster.hp<=0;
  const canUpByBest = state.floor < state.roundMaxFloor;
  return dead || canUpByBest;
}
function refreshFloorHints(){
  const bi=currentBlockIdx();
  const theme=ensureThemeForBlock(bi);
  const stage=ensureStageNameForBlock(bi,theme);
  const msg=`ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜ï¼š${state.roundMaxFloor} éš / é€šç®—æœ€é«˜ï¼š${state.bestMaxFloor} éš / ãƒ†ãƒ¼ãƒï¼š${themeLabel(theme)} / ã‚¹ãƒ†ãƒ¼ã‚¸ï¼š${stage}`;
  if(ui.fmHint) ui.fmHint.textContent=msg;
  if(ui.fmNext) ui.fmNext.disabled=!canGoNext();
  if(ui.fmPrev) ui.fmPrev.disabled=state.floor<=1;
  if(ui.fmStay) ui.fmStay.checked=!!state.stay;
}
function toggleFloorMenu(show){
  if(!ui.floorMenu) return;
  ui.floorMenu.hidden=(show===undefined)?!ui.floorMenu.hidden:!show;
  if(!ui.floorMenu.hidden){ Sound.play('ui'); refreshFloorHints(); }
}
on(ui.floorMenuBtn,'click',()=>toggleFloorMenu());
on(document,'click',(e)=>{
  if(!ui.floorMenu||ui.floorMenu.hidden) return;
  const within=ui.floorMenu.contains(e.target)||ui.floorMenuBtn.contains(e.target);
  if(!within) ui.floorMenu.hidden=true;
});
on(ui.fmPrev,'click',()=>{ state.floor=Math.max(1,state.floor-1); state.playerHP=recalcMaxHP(); state.isDown=false; state.reviveAt=0; state.engaged=false; spawnMonster(); updateUI(); Sound.play('ui'); refreshFloorHints(); });
on(ui.fmNext,'click',()=>{ if(!canGoNext()){ toast('ã¾ã é€²ã‚ãªã„â€¦'); Sound.play('error'); return } state.floor+=1; state.playerHP=recalcMaxHP(); state.isDown=false; state.reviveAt=0; state.engaged=false; spawnMonster(); updateUI(); Sound.play('ui'); refreshFloorHints(); });
on(ui.fmStay,'change',e=>{ state.stay=!!e.target.checked; Sound.play('ui'); });

/* æ•°å­—å…¥åŠ›ã®æ”¹å–„ï¼ˆiOSç­‰ï¼‰ */
if(ui.fmJumpInput){
  ui.fmJumpInput.setAttribute('inputmode','numeric');
  ui.fmJumpInput.setAttribute('pattern','[0-9]*');
  ui.fmJumpInput.setAttribute('step','1');
}
on(ui.fmJumpGo,'click',()=>{
  const v=parseInt((ui.fmJumpInput?.value||'').replace(/[^\d]/g,''),10);
  if(!v || v<1){ Sound.play('error'); return }
  const to = Math.min(v, Math.max(1, state.roundMaxFloor)); // â˜…ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜ã¾ã§
  state.floor=to; state.playerHP=recalcMaxHP(); state.isDown=false; state.reviveAt=0; state.engaged=false;
  spawnMonster(); updateUI(); Sound.play('ui'); refreshFloorHints();
});
on(ui.fmJumpInput,'keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); ui.fmJumpGo.click(); }});

/* ---------------------------
   ã‚»ãƒ¼ãƒ–ï¼ãƒ­ãƒ¼ãƒ‰ï¼ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
---------------------------- */
function ensureJsonFilename(base){ const nm=(base||'').trim(); return /\.json$/i.test(nm)? nm : nm+'.json'; }
function jsonNow(){ const z=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${z.getFullYear()}${pad(z.getMonth()+1)}${pad(z.getDate())}-${pad(z.getHours())}${pad(z.getMinutes())}${pad(z.getSeconds())}` }
on(ui.downloadBtn,'click',()=>{
  const uname=(state.username||'User');
  const given=(ui.exportName?.value||'').trim();
  const base = given || `save-${uname}-${jsonNow()}`;
  const name=ensureJsonFilename(base);
  const payload=JSON.stringify({state:{...state,bossEndsAt:0,reviveAt:0},prices,version:GAME_VERSION},null,2);
  try{ localStorage.setItem(SAVE_KEY, payload);}catch(e){}
  const blob=new Blob([payload],{type:'application/json'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000); toast('ã‚»ãƒ¼ãƒ–ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
});
on(ui.importFileBtn,'click',()=>{ if(!ui.fileOpenSettings) return; ui.fileOpenSettings.value=''; ui.fileOpenSettings.click(); });
function readFileAsText(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error); r.readAsText(file,'utf-8'); }); }
on(ui.fileOpenSettings,'change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ const txt=await readFileAsText(f); if(importSaveFromText(txt)){ toast('èª­ã¿è¾¼ã¿OK'); updateUI(); renderInventory(); } }
  catch(_){ toast('èª­è¾¼ã‚¨ãƒ©ãƒ¼'); }
});
on(ui.wipeBtn,'click',()=>{ const msg='å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€ç”»é¢ã‚’æ›´æ–°ã—ã¾ã™ã€‚\n\nâ€»å‰Šé™¤å‰ã«å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ã—ã¦ãã ã•ã„ã€‚'; if(!confirm(msg)) return; localStorage.removeItem(SAVE_KEY); localStorage.removeItem(STAGE_KEY); location.reload(); });
on(ui.nameSave,'click',()=>{ const nm=(ui.nameEdit?.value||'').trim(); if(!nm){ toast('åå‰ã‚’å…¥åŠ›'); return } state.username=nm; save(false); toast('OK'); });

function save(manual=false){
  try{
    const data=JSON.stringify({state:{...state,bossEndsAt:0,reviveAt:0},prices});
    localStorage.setItem(SAVE_KEY,data);
    if(manual) toast('ä¿å­˜ã—ã¾ã—ãŸ');
  }catch(e){ console.warn(e); }
}
function load(manual=false){
  try{
    const raw=localStorage.getItem(SAVE_KEY); if(!raw){ if(manual) toast('ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚»ãƒ¼ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return false }
    const o=JSON.parse(raw);
    Object.assign(state,o.state||{}); Object.assign(prices,o.prices||{});
    // äº’æ›
    state.roundMaxFloor = state.roundMaxFloor||1;
    state.bestMaxFloor  = state.bestMaxFloor || state.maxFloor || 1;
    // æ—§enh â†’ enhlv
    ['weapon','armor','ring'].forEach(s=>{ const it=state.eq[s]; if(it && it.enh && !it.enhlv){ it.enhlv=it.enh; delete it.enh; } });
    state.playerHP=clamp(state.playerHP,0,recalcMaxHP());
    ui.autoEquip&&(ui.autoEquip.checked=!!state.autoEquip);
    ensureUniqueSwordItem(); renderInventory(); updateUI();
    if(manual) toast('èª­è¾¼ã—ã¾ã—ãŸ');
    return true;
  }catch(e){ console.warn(e); if(manual) toast('èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); return false }
}
function importSaveFromText(raw){ try{ JSON.parse(raw); localStorage.setItem(SAVE_KEY, raw); return load(false); }catch(e){ toast('JSONã‚¨ãƒ©ãƒ¼'); return false } }

/* ---------------------------
   ã‚³ãƒ¼ãƒ‰ç‰¹å…¸ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
---------------------------- */
on(ui.codeBtn,'click',()=>{
  const code=(ui.codeInput?.value||'').trim();
  if(!code){ ui.codeStatus&&(ui.codeStatus.textContent='ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›'); return }
  if(code==='kashiwa060925'){ if(state.unlocks.kashiwa){ ui.codeStatus.textContent='ä½¿ç”¨æ¸ˆã¿'; return } state.unlocks.kashiwa=true; ui.codeStatus.textContent='OKï¼šæŸã®åŠ è­·ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰'; updateUI(); save(false); return; }
  if(code==='kashiwa77'){ if(state.unlocks.strongsword){ ui.codeStatus.textContent='ä½¿ç”¨æ¸ˆã¿'; return } state.unlocks.strongsword=true; ui.codeStatus.textContent='OKï¼šãƒ„ãƒ¨ã‚¹ã‚®ãƒ†=ã‚¯ã‚µãƒã‚¨ãƒ«ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰'; updateUI(); save(false); return; }
  ui.codeStatus.textContent='NG';
});
on(ui.relicKashiwa,'change',e=>{ state.relicActive.kashiwa=e.target.checked; save(false); });
on(ui.relicStrongSword,'change',e=>{ state.relicActive.strongsword=e.target.checked; save(false); });

/* ---------------------------
   è»¢ç”Ÿï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰è¨˜éŒ²ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
---------------------------- */
function calcSoulGain(){ return Math.floor((state.roundMaxFloor||1)/30) }
on(ui.ascendBtn,'click',()=>{
  const gain=calcSoulGain();
  if(!confirm(`è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ\n\nç²å¾—ã‚½ã‚¦ãƒ«ï¼š${gain}\n\nâ€»ãƒ¬ãƒ™ãƒ«/å¼·åŒ–/é€šå¸¸è£…å‚™ã¯å®Œå…¨ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚`)) return;
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å€¤ã‚’å…ˆã«ã‚»ãƒƒãƒˆ
  ui.ascSoulGained&&(ui.ascSoulGained.textContent=gain);
  ui.ascRoundReached&&(ui.ascRoundReached.textContent=state.roundMaxFloor||1);
  ui.ascBestReached&&(ui.ascBestReached.textContent=state.bestMaxFloor||1);

  state.souls+=gain; state.ascCount=(state.ascCount||0)+1;

  // ãƒ©ã‚¦ãƒ³ãƒ‰ã®ãƒªã‚»ãƒƒãƒˆ
  state.level=1; state.exp=0; state.expToNext=20;
  state.baseATK=1; state.baseHP=10; state.autoTap=0; state.upg={atk:0,hp:0,auto:0};
  state.eq={weapon:null,armor:null,ring:null};
  state.inv = state.inv.filter(it=>it.persist||it.id==='unique_demon'); ensureUniqueSwordItem();

  // ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜ãƒªã‚»ãƒƒãƒˆã€é€šç®—æœ€é«˜ç¶­æŒ
  state.roundMaxFloor=1;
  state.floor=1; state.playerHP=recalcMaxHP();
  state.kills=0; state.deaths=0;
  state.isDown=false; state.reviveAt=0; state.engaged=false;

  // è¡¨ç¤º
  spawnMonster(); updateUI(); save(false);
  ui.ascModal&&(ui.ascModal.style.display='flex');
});
on(ui.ascClose,'click',()=>{ ui.ascModal&&(ui.ascModal.style.display='none'); });

/* ---------------------------
   UIæ›´æ–°
---------------------------- */
function updateAttackBtn(){ const m=state.monster; if(!m||!ui.attackBtn) return; const expected=playerATK(); if(!state.engaged){ ui.attackBtn.textContent=(expected>=m.hp)?'å€’ã™':'æˆ¦é—˜é–‹å§‹ï¼'; return } ui.attackBtn.textContent=(expected>=m.hp)?'å€’ã™':'æ”»æ’ƒï¼ˆã‚¿ãƒƒãƒ—ï¼‰'; }

function updateUI(){
  // ä¸Šéƒ¨
  ui.c_gold&&(ui.c_gold.textContent=Math.floor(state.gold));
  ui.c_level&&(ui.c_level.textContent=state.level);
  ui.c_exp&&(ui.c_exp.textContent=`${state.exp}/${state.expToNext}`);
  ui.x_floor&&(ui.x_floor.textContent=state.floor);
  ui.x_level&&(ui.x_level.textContent=state.level);
  ui.x_exp&&(ui.x_exp.textContent=`${state.exp}/${state.expToNext}`);
  ui.x_atk&&(ui.x_atk.textContent=playerATK());
  ui.x_gold&&(ui.x_gold.textContent=Math.floor(state.gold));
  ui.x_souls&&(ui.x_souls.textContent=state.souls);
  ui.x_crit&&(ui.x_crit.textContent=`${Math.floor(playerCRIT())}%`);
  const mx=recalcMaxHP(); const pct=clamp(state.playerHP/mx*100,0,100);
  ui.x_hpbar&&(ui.x_hpbar.style.width=`${pct}%`);
  ui.x_hptxt&&(ui.x_hptxt.textContent=`${Math.floor(state.playerHP)}/${mx}`);

  // å¼·åŒ–ä¾¡æ ¼
  ui.upgGold&&(ui.upgGold.textContent=Math.floor(state.gold));
  ui.lvAtk&&(ui.lvAtk.textContent=state.upg.atk||0);
  ui.lvHP&&(ui.lvHP.textContent=state.upg.hp||0);
  ui.lvAuto&&(ui.lvAuto.textContent=state.upg.auto||0);
  ui.countAtk&&(ui.countAtk.textContent=`è³¼å…¥å›æ•°ï¼š${state.upg.atk||0}`);
  ui.countHP&&(ui.countHP.textContent=`è³¼å…¥å›æ•°ï¼š${state.upg.hp||0}`);
  ui.countAuto&&(ui.countAuto.textContent=`è³¼å…¥å›æ•°ï¼š${state.upg.auto||0}`);
  ui.costAtk&&(ui.costAtk.textContent=prices.atk);
  ui.costHP&&(ui.costHP.textContent=prices.hp);
  ui.costAuto&&(ui.costAuto.textContent=prices.auto);

  // ãƒãƒƒã‚¸ï¼ˆåœ°åä½µè¨˜ï¼‰
  if(ui.floorBadge){
    ui.floorBadge.innerHTML = badgeTextForFloor();
    ui.themeBadge=document.getElementById('themeBadge');
  }

  // çµ±è¨ˆï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ï¼é€šç®—ï¼‰
  ui.staRoundMax&&(ui.staRoundMax.textContent=state.roundMaxFloor||1);
  ui.staBestMax&&(ui.staBestMax.textContent=state.bestMaxFloor||1);
  ui.staAtk&&(ui.staAtk.textContent=playerATK());
  ui.staHP&&(ui.staHP.textContent=recalcMaxHP());
  ui.staDef&&(ui.staDef.textContent=state.baseDEF+(state.eq.armor?.def||0));
  ui.staCrit&&(ui.staCrit.textContent=`${Math.floor(playerCRIT())}%`);
  ui.staAutoTap&&(ui.staAutoTap.textContent=(state.autoTap||0).toFixed(1));
  ui.staGoldB&&(ui.staGoldB.textContent=`${Math.floor(goldB())}%`);
  ui.staItemDrop&&(ui.staItemDrop.textContent=`${(getItemDrop()*100).toFixed(1)}%`);
  ui.staAsc&&(ui.staAsc.textContent=state.ascCount||0);
  // æ‰€æŒ
  ui.bagGold&&(ui.bagGold.textContent=Math.floor(state.gold));
  ui.bagSoul&&(ui.bagSoul.textContent=state.souls);
  ui.bagSoulSpent&&(ui.bagSoulSpent.textContent=state.soulsSpent);
  ui.bagGem&&(ui.bagGem.textContent=state.magicStones);
  ui.bagPeb&&(ui.bagPeb.textContent=state.pebbles);
  ui.bagEq&&(ui.bagEq.textContent=state.inv.length);

  renderEquipped(); refreshDemonList(); updateRelicUI(); refreshBulkNote();
}

/* ---------------------------
   æ”»æ’ƒå…¥åŠ›ï¼ˆç”»é¢ï¼‰
---------------------------- */
function beginEngage(){ if(!state.engaged){ state.engaged=true; } }
let _holding=false,_t=0,_saw=false;
function onPD(e){ e.preventDefault(); _saw=true; _t=Date.now(); if(_holding) return; _holding=true; attack(); }
function onPU(){ _holding=false }
function bindInput(el){
  if(!el) return;
  if(window.PointerEvent){
    on(el,'pointerdown',onPD,{passive:false});
    on(el,'pointerup',onPU); on(el,'pointercancel',onPU); on(el,'pointerleave',onPU);
  } else {
    on(el,'click',()=>{ if(_saw && Date.now()-_t<200) return; attack(); });
  }
}

/* ---------------------------
   ç”Ÿæˆï¼†æˆ¦é—˜ï¼ˆPart2ã§å®šç¾©ï¼‰
   ã“ã“ã§ã¯ã€é€²è¡Œã«ä¼´ã†ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜æ›´æ–°ã¨
   ã¾ã¨ã‚è¸ç ´ãƒ­ã‚°ã®è¿½åŠ ã ã‘è£œå¼·
---------------------------- */
const old_doKillAdvanceAndMaybeStay = (typeof doKillAdvanceAndMaybeStay==='function')? doKillAdvanceAndMaybeStay : null;
// ã¾ã¨ã‚è¸ç ´ã‚’æ¤œçŸ¥ã™ã‚‹ãŸã‚ã€attack()å†…ã®ã‚­ãƒ«å‡¦ç†ã¯Part2ã§å®Ÿè£…æ¸ˆã¿ã€‚
// ã“ã“ã§ã¯ãƒ•ãƒƒã‚¯ã¨ã—ã¦ floor é€²è¡Œå¾Œã« round/best ã‚’æ›´æ–°ã—ã€å¿…è¦ãªã‚‰è¸ç ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼†GMåå¿œã‚’å‡ºã™ã€‚
function afterChainProgress(killsInChain){
  if(state.stay) return; // ç•™ã¾ã‚‹è¨­å®šã®æ™‚ã¯è¸ç ´ã—ãªã„
  const advanced = Math.max(0, killsInChain-1);
  if(advanced<=0) return;

  // ãƒ©ã‚¦ãƒ³ãƒ‰æœ€é«˜æ›´æ–°
  if(state.floor>state.roundMaxFloor) state.roundMaxFloor=state.floor;
  if(state.roundMaxFloor>state.bestMaxFloor) state.bestMaxFloor=state.roundMaxFloor;

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  pushLog(pickStrideMsg(advanced));
  const gm = gmReactScaled(advanced); if(gm) pushLog(`<b>${gm}</b>`);
}

/* ---------------------------
   ãƒ«ãƒ¼ãƒ— & åˆæœŸåŒ–
---------------------------- */
let last=performance.now(), _loopStarted=false;
function loop(nowTs){
  const dt=Math.min(0.1,(nowTs-last)/1000); last=nowTs;
  autoTapTick(dt); enemyTick(dt); regenTick(dt); timersTick(dt); updateUI();
  requestAnimationFrame(loop);
}
function startLoop(){ if(_loopStarted) return; _loopStarted=true; requestAnimationFrame(loop); }

function hasSave(){ try{ return !!localStorage.getItem(SAVE_KEY) }catch(e){ return false } }
function setPrimaryButton(){
  if(!ui.btnPrimary) return;
  if(hasSave()){ ui.btnPrimary.setAttribute('data-mode','local'); ui.btnPrimary.textContent='ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼'; }
  else { ui.btnPrimary.setAttribute('data-mode','new'); ui.btnPrimary.textContent='ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ '; }
}

window.addEventListener('error',(e)=>{ if(ui.startError) ui.startError.textContent='åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼š'+(e?.error?.message||e.message||'ä¸æ˜'); });

function safeInit(){
  try{
    ui.verText&&(ui.verText.textContent=GAME_VERSION);
    loadAudioSettings(); // BGMè¨­å®šå«ã‚€
    // åˆæœŸã‚¿ãƒ–
    switchMainTab('tab-upg');
    const saved=localStorage.getItem(UI_MODE); applyCollapsed(saved!=='0');
    ui.saveDetect&&(ui.saveDetect.textContent=hasSave()?'OK':'â€”'); setPrimaryButton();
    window.addEventListener('beforeunload',()=>save(false));
  }catch(e){ console.error(e); if(ui.startError) ui.startError.textContent='åˆæœŸåŒ–å¤±æ•—ï¼š'+e.message; }
}
function applyCollapsed(col){
  if(!ui.toggleInfo) return;
  if(col){ ui.topCollapsed&&ui.topCollapsed.removeAttribute('hidden'); ui.topExpanded&&ui.topExpanded.setAttribute('hidden',''); ui.toggleInfo.setAttribute('aria-expanded','false'); ui.toggleInfo.textContent='â–¼ è©³ç´°'; }
  else   { ui.topCollapsed&&ui.topCollapsed.setAttribute('hidden',''); ui.topExpanded&&ui.topExpanded.removeAttribute('hidden'); ui.toggleInfo.setAttribute('aria-expanded','true');  ui.toggleInfo.textContent='â–² é–‰ã˜ã‚‹'; }
  localStorage.setItem(UI_MODE,col?'1':'0');
}
on(ui.toggleInfo,'click',()=>{ const col=ui.toggleInfo.getAttribute('aria-expanded')==='true'; applyCollapsed(col) });

function beginGame(uname){
  if(!uname) uname='æ—…äºº';
  state.username=uname; state.playerHP=recalcMaxHP(); ensureUniqueSwordItem();
  // åˆæœŸã‚¹ãƒãƒ¼ãƒ³
  spawnMonster(); renderInventory(); updateUI(); save(false);
  if(ui.startOverlay) ui.startOverlay.hidden=true; startLoop(); Sound.play('ui');
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§Audioèµ·å‹• */
function onAnyStartAction(){ seInitOnUserGesture(); }
['click','pointerdown','touchstart','keydown'].forEach(ev=>{
  on(ui.btnPrimary,ev,onAnyStartAction,{passive:true});
  on(ui.btnBegin,ev,onAnyStartAction,{passive:true});
  on(ui.btnStartImportFile,ev,onAnyStartAction,{passive:true});
  document.addEventListener(ev,onAnyStartAction,{once:true,passive:true});
});

on(ui.btnPrimary,'click',()=>{
  const mode=ui.btnPrimary.getAttribute('data-mode');
  if(mode==='local'){
    if(load(false)){ beginGame(state.username||'æ—…äºº'); }
    else { if(ui.startNote) ui.startNote.textContent='ã‚»ãƒ¼ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ â†’ ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã™'; setPrimaryButton(); }
  } else if(mode==='new'){
    const nm=(ui.startName?.value||'').trim(); beginGame(nm);
  }
});
on(ui.btnStartImportFile,'click',()=>{ if(!ui.fileOpenStart) return; ui.fileOpenStart.value=''; ui.fileOpenStart.click(); });
on(ui.fileOpenStart,'change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ const txt=await readFileAsText(f); if(importSaveFromText(txt)){ beginGame(state.username||'æ—…äºº'); } }
  catch(_){ if(ui.startNote) ui.startNote.textContent='èª­è¾¼ã‚¨ãƒ©ãƒ¼'; }
});
on(ui.btnBegin,'click',()=>{ const nm=(ui.startName?.value||'').trim(); beginGame(nm); });
on(document,'dblclick',e=>e.preventDefault(),{passive:false});

/* ç”»é¢ã¸ã®æ“ä½œãƒã‚¤ãƒ³ãƒ‰ */
bindInput(ui.attackBtn); bindInput($('#monster'));

/* èµ·å‹• */
safeInit();
</script>
</body>
</html>